---
title: "CDC Data ETL"
author: "Jesse DeBolt & Isaac Johnson"
date: "`r Sys.Date()`"
output: html_document
---

### Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# Load the necessary libraries
library(httr)
library(readr)
library(tidyverse)
library(gdata)
library(skimr)
library(DataExplorer)
library(GGally)
library(caret)

```


### List of files located in the GitHub repository data folder
```{r}
# File names list
filenames <- c("SEED-UR-Urban-Rural.csv",
               "SEED-SE-Unemployment_Rate.csv",
               "SEED-SE-Severe_Housing_Cost_Burden.csv",
               "SEED-SE-Poverty.csv",
               "SEED-SE-Median_Household_Income.csv",
               "SEED-SE-Median_Home_Value.csv",
               "SEED-SE-Income_Inequality.csv",
               "SEED-SE-Food_Stamp_SNAP_recipients.csv",
               "SEED-SE-Education-LessThanHighSchool.csv",
               "SEED-SE-Education-LessThanCollege.csv",
               "SEED-SE-Computer.csv",
               "SEED-SE-Broadband.csv",
               "SEED-PE-Park_Access.csv",
               "SEED-PE-Air_Quality.csv",
               "RF-Smoking.csv",
               "RF-Physical_Inactivity.csv",
               "RF-Obesity.csv",
               "RF-High_Cholesterol.csv",
               "RF-Diagnosed_Diabetes.csv",
               "Prev-Stroke.csv",
               "Prev-High_Blood_Pressure.csv",
               "Prev-Coronary_Heart_Disease.csv",
               "HCDI-PS-PCP.csv",
               "HCDI-PS-Neurosurgeons.csv",
               "HCDI-PS-Neurologists.csv",
               "HCDI-PS-CDP.csv",
               "HCDI-Insurance-Health_Insurance_Status.csv",
               "HCDI-HP-Pharmacies_and_Drug_Stores.csv",
               "HCDI-HP-Hospitals-Services-NS.csv",
               "HCDI-HP-Hospitals-Services-ED.csv",
               "HCDI-HP-Hospitals-Services-CIC.csv",
               "HCDI-HP-Hospitals-Services-CA.csv",
               "HCDI-HP-Hospitals.csv",
               "HCDI-CRU-Participation_Among_Eligible.csv",
               "HCDI-CRU-Eligibility_Rate.csv",
               "HCDI-CLM-Nonadherence.csv",
               "HCDI-Cholesterol_Screening.csv",
               "HCDI-BPM-Medication_Use.csv",
               "Demo-Total_Population.csv"
               )

```


### Create a function to generate the URL for a given filename
```{r}
generate_url <- function(filename) {
  return(paste0("https://raw.githubusercontent.com/jessedebolt/MSDS-Capstone/main/data_raw/", filename))
}

```


### Generate urls for each filename
```{r}
urls <- sapply(filenames, generate_url)

```


### Read the CSV files into a list of data frames
```{r }
# Read the CSV files into a list of data frames
df_list <- lapply(urls, read_csv)

# Create names for the list items (remove the .csv from the filenames)
names(df_list) <- sapply(filenames, function(filename) gsub(".csv", "", filename))

# Create individual data frames
list2env(df_list, .GlobalEnv)

```


### Merge all sets together into one data frame
```{r}
# Get all the data frame names in the global environment
df_names <- ls(.GlobalEnv)

# Initialize an empty data frame for the final result
cdc <- data.frame()

# Loop through each data frame
for (df_name in df_names) {
  
  # Get the data frame
  df <- get(df_name, envir = .GlobalEnv)
  
  # Check if 'cnty_fips' and 'display_name' exist in the data frame
  if(all(c("cnty_fips", "display_name") %in% colnames(df))){
    
    # Convert 'cnty_fips' column to character type
    df$cnty_fips <- as.character(df$cnty_fips)
    
    # Select all columns excluding those with "theme_range" in their name
    df <- df %>%
      select(-contains("theme_range"))

    # Rename each variable, except 'cnty_fips' and 'display_name', to include the data frame name
    df <- df %>%
      rename_with(.cols = -c(cnty_fips, display_name),
                  .fn = ~ paste(df_name, ., sep = "_"))
    
    # Join the data frame with the final data frame
    if (nrow(cdc) == 0){
      cdc <- df
    } else {
      cdc <- full_join(cdc, df, by = c("cnty_fips", "display_name"))
      
      # Remove the ".x" from the column names
      names(cdc) <- gsub("\\.x$", "", names(cdc))
      
      # Remove the "_Value" from the column names
      names(cdc) <- gsub("\\_Value$", "", names(cdc))
    }
  }
}

# Clean up global environment
keep(cdc, sure = TRUE)

```


### Make backup and display first few rows
```{r}
cdc_copy <- cdc

head(cdc)

#cdc <- cdc_copy

```


## Cleaning up some variables

### Removing US territories
```{r}
cdc <- cdc_copy
cdc <- cdc %>%
  filter(!grepl("\\(AS\\)|\\(GU\\)|\\(MP\\)|\\(PR\\)|\\(County Equivalent\\)", as.character(display_name)))

```


### Separated County and State
```{r}
# Separate the 'display_name' column
cdc <- cdc %>% separate(display_name, into = c("county", "state"), sep = ", \\(|\\)", remove = TRUE, convert = TRUE)

# Remove the closing parenthesis from the state column
cdc$state <- gsub("\\)", "", cdc$state)

print(cdc)

```


### Relabeling Urban/Rural codes
```{r}
#change rural/urban
# 1 = Large central metro -> Large_Urban
# 2 = Large fringe metro -> LargeFringe_Urban
# 3 = Medium/small metro -> MediumSmall_Urban
# 4 = Nonmetro -> Rural

cdc$"SEED-UR-Urban-Rural" <- ifelse(cdc$"SEED-UR-Urban-Rural"
                                         == 1, "Large_Urban",
                                  ifelse(cdc$"SEED-UR-Urban-Rural"
                                         == 2,"LargeFringe_Urban",
                                  ifelse(cdc$"SEED-UR-Urban-Rural" 
                                         == 3,"MediumSmall_Urban", 
                                  ifelse(cdc$"SEED-UR-Urban-Rural"
                                         == 4,"Rural",
                                  cdc$"SEED-UR-Urban-Rural"))))

### Replacing '-1' with 'NA' under assumption that these are truly missing elements
cdc[cdc == -1] <- NA

```


### Review header names, check for missing rural/urban values
```{r}
names(cdc)

unique(cdc$'SEED-UR-Urban-Rural')

rural_query <- filter(cdc, `SEED-UR-Urban-Rural` %in% c(NA, "", "NA"))

head(rural_query, n=20)

```


### Imputing Rural/Urban for missing value
```{r}
# Find and impute where county is 'Kusilvak'
# BLAH


# Double check for any NAs in Rural/Urban
rural_query <- filter(cdc, `SEED-UR-Urban-Rural` %in% c(NA, "", "NA"))
head(rural_query, n=20)

```


### Export complete dataframe to csv
```{r}
# Write data to local in csv format
write_csv(cdc, "data/CDC_all.csv")  

```


```{r}
head(cdc)

```


# EDA

### EDA (Initial look)
```{r}
head(cdc)
str(cdc)
dim(cdc)
summary(cdc)
skim(cdc)

```

### Any missing values?
```{r}

#total number of missing values in each column
colSums(is.na(cdc))

#total number of missing values in dataset
sum(is.na(cdc))

```


### Let's pook at CHD prevalence
```{r}
hist(cdc$"Prev-Coronary_Heart_Disease")

#Why are some prevalence values -1? Let's look at them. Maybe it's a non-reporting issue?
sort(unique(cdc$"Prev-Coronary_Heart_Disease"))
chd_query <- filter(cdc, "Prev-Coronary_Heart_Disease" == -1)
head(chd_query, n=20)

top_10 <- top_n(cdc, n=10, "Prev-Coronary_Heart_Disease")
top_10

bottom_10 <- cdc %>%
    arrange("Prev-Coronary_Heart_Disease") %>%
    tail(10)

```

##EDA 10 Counties with highest CHD prevalence
```{r}

highest_10 <- top_n(cdc, n=10, "Prev-Coronary_Heart_Disease")
highest_10 %>%
    arrange(desc("Prev-Coronary_Heart_Disease"))

```
##EDA 10 Counties with lowest CHD prevalence
```{r}

lowest_10 <- cdc %>%
    filter("Prev-Coronary_Heart_Disease" != -1) %>%
    arrange("Prev-Coronary_Heart_Disease") %>%
    head(10)
lowest_10

```

##EDA Correlation
```{r}
plot_correlation(cdc)

```


##EDA (auto EDA report)
```{r}
# 
# cdc %>%
#     create_report(
#         output_file = paste ("Report", format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z"), sep=" - "),
#         report_title = "EDA Report - CHD Dataset",
#         y = "cardio"
#     )

```

##EDA GGally
```{r}

cdc %>%
    select("Prev-Coronary_Heart_Disease", "Prev-High_Blood_Pressure", "Prev-Stroke", "SEED-UR-Urban-Rural") %>%
    ggpairs(mapping = aes(color = cdc$"SEED-UR-Urban-Rural", alpha = 0.5))

```

### Correlation plot for CHD and prevalence of other heart conditions factors
```{r}
cdc %>%
    select("Prev-Coronary_Heart_Disease",
           "Prev-High_Blood_Pressure",
           "Prev-Stroke",
           "SEED-UR-Urban-Rural") %>%
    ggpairs(mapping = aes(color = cdc$"SEED-UR-Urban-Rural", alpha = 0.5))

```


### Correlation plot for CHD and hospitals and pharmacy access factors
```{r}
cdc %>%
    select("Prev-Coronary_Heart_Disease",
            "HCDI-HP-Hospitals",
            "HCDI-HP-Hospitals-Services-CA",
            "HCDI-HP-Hospitals-Services-CIC",
            "HCDI-HP-Hospitals-Services-ED",
            "HCDI-HP-Hospitals-Services-NS",
            "HCDI-HP-Pharmacies_and_Drug_Stores",
            "SEED-UR-Urban-Rural") %>%
    ggpairs(mapping = aes(color = cdc$"SEED-UR-Urban-Rural", alpha = 0.5))

```


### Correlation plot for CHD and various health care delivery and insurance factors
```{r}
cdc %>%
    select("Prev-Coronary_Heart_Disease",
           "HCDI-BPM-Medication_Use",
           "HCDI-Cholesterol_Screening",
           "HCDI-CLM-Nonadherence",
           "HCDI-CRU-Eligibility_Rate",
           "HCDI-CRU-Participation_Among_Eligible",
           "HCDI-Insurance-Health_Insurance_Status",
           "HCDI-PS-CDP",
           "HCDI-PS-Neurologists",
           "HCDI-PS-Neurosurgeons",
           "HCDI-PS-PCP",
           "SEED-UR-Urban-Rural") %>%
    ggpairs(mapping = aes(color = cdc$"SEED-UR-Urban-Rural", alpha = 0.5))

```


### Correlation plot for CHD and various risk factors
```{r}
cdc %>%
    select("Prev-Coronary_Heart_Disease",
           "RF-Diagnosed_Diabetes",
           "RF-High_Cholesterol",
           "RF-Obesity",
           "RF-Physical_Inactivity",
           "RF-Smoking",
           "SEED-UR-Urban-Rural") %>%
    ggpairs(mapping = aes(color = cdc$"SEED-UR-Urban-Rural", alpha = 0.5))

```


### Correlation plot for CHD and various physical environment factors
```{r}
cdc %>%
    select("Prev-Coronary_Heart_Disease",
           "SEED-PE-Air_Quality",
           "SEED-PE-Park_Access",
           "SEED-UR-Urban-Rural",
           "SEED-UR-Urban-Rural") %>%
    ggpairs(mapping = aes(color = cdc$"SEED-UR-Urban-Rural", alpha = 0.5))

```


### Correlation plot for CHD and various social environmental factors
```{r}
cdc %>%
    select("Prev-Coronary_Heart_Disease",
           "SEED-SE-Broadband",
           "SEED-SE-Computer",
           "SEED-SE-Education-LessThanCollege",
           "SEED-SE-Education-LessThanHighSchool",
           "SEED-SE-Food_Stamp_SNAP_recipients",
           "SEED-SE-Income_Inequality",
           "SEED-SE-Median_Home",
           "SEED-SE-Median_Household_Income",
           "SEED-SE-Poverty",
           "SEED-SE-Severe_Housing_Cost_Burden",
           "SEED-SE-Unemployment_Rate",
           "SEED-UR-Urban-Rural") %>%
    ggpairs(mapping = aes(color = cdc$"SEED-UR-Urban-Rural", alpha = 0.5))
```



# New EDA (not useful as it is primarily a tool for data compression and visualization, also too many NAs)
### Prepare data for principle component analysis
```{r}
# Remove non-numeric variables
cdc_comp <- cdc %>% 
  select(-c("cnty_fips", "county", "state", "SEED-UR-Urban-Rural"))

# Remove NAs
cdc_comp[is.na(cdc_comp)] <- 0

# Double check to see if all entries are finite
all(sapply(cdc_comp, is.finite))

```

#PCA
###* Run PCA on the dataset.
```{r results='hide'}
pr_income <- prcomp(x = cdc_comp, scale = T, center = T)

summary(pr_income)

```

