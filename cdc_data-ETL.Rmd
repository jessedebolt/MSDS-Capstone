---
title: "CDC Data ETL"
author: "Jesse DeBolt & Isaac Johnson"
date: "`r Sys.Date()`"
output: html_document
---


# Primary Document for all code
## Setup
### Load libraries and knit setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# Load the necessary libraries
library(httr)
library(readr)
library(tidyverse)
library(gdata)
library(skimr)
library(DataExplorer)
library(GGally)
library(caret)

```


### Files located in the GitHub repository data folder
```{r}
# File names list
filenames <- c("SEED-UR-Urban-Rural.csv",
               "SEED-SE-Unemployment_Rate.csv",
               "SEED-SE-Severe_Housing_Cost_Burden.csv",
               "SEED-SE-Poverty.csv",
               "SEED-SE-Median_Household_Income.csv",
               "SEED-SE-Median_Home_Value.csv",
               "SEED-SE-Income_Inequality.csv", #REMOVE?
               "SEED-SE-Food_Stamp_SNAP_recipients.csv",
               "SEED-SE-Education-LessThanHighSchool.csv", #REMOVE?
               "SEED-SE-Education-LessThanCollege.csv",
               "SEED-SE-Computer.csv", #REMOVE?
               "SEED-SE-Broadband.csv",
               "SEED-PE-Park_Access.csv", #REMOVE?
               "SEED-PE-Air_Quality.csv", #REMOVE?
               "RF-Smoking.csv",
               "RF-Physical_Inactivity.csv",
               "RF-Obesity.csv",
               "RF-High_Cholesterol.csv",
               "RF-Diagnosed_Diabetes.csv",
               "Prev-Stroke.csv",
               "Prev-High_Blood_Pressure.csv",
               "Prev-Coronary_Heart_Disease.csv",
               "HCDI-PS-PCP.csv",
               "HCDI-PS-Neurosurgeons.csv", #REMOVE?
               "HCDI-PS-Neurologists.csv", #REMOVE?
               "HCDI-PS-CDP.csv",
               "HCDI-Insurance-Health_Insurance_Status.csv", #REMOVE?
               "HCDI-HP-Pharmacies_and_Drug_Stores.csv",
               "HCDI-HP-Hospitals-Services-NS.csv", #REMOVE?
               "HCDI-HP-Hospitals-Services-ED.csv",
               "HCDI-HP-Hospitals-Services-CIC.csv",
               "HCDI-HP-Hospitals-Services-CR.csv",
               "HCDI-HP-Hospitals.csv",
               "HCDI-CRU-Participation_Among_Eligible.csv",
               "HCDI-CRU-Eligibility_Rate.csv",
               "HCDI-CLM-Nonadherence.csv",
               "HCDI-Cholesterol_Screening.csv",
               "HCDI-BPM-Medication_Use.csv",
               "Demo-Total_Population.csv"
               )

```


### Create a function to generate the URL for a given filename
```{r}
generate_url <- function(filename) {
  return(paste0("https://raw.githubusercontent.com/jessedebolt/MSDS-Capstone/main/data_raw/", filename))
}

```


### Generate urls for each filename
```{r}
urls <- sapply(filenames, generate_url)

```


### Read the CSV files into a list of data frames
```{r }
# Read the CSV files into a list of data frames
df_list <- lapply(urls, read_csv)

# Create names for the list items (remove the .csv from the filenames)
names(df_list) <- sapply(filenames, function(filename) gsub(".csv", "", filename))

# Create individual data frames
list2env(df_list, .GlobalEnv)

```


### Merge all sets together into one data frame
```{r}
# Get all the data frame names in the global environment
df_names <- ls(.GlobalEnv)

# Initialize an empty data frame for the final result
cdc <- data.frame()

# Loop through each data frame
for (df_name in df_names) {
  
  # Get the data frame
  df <- get(df_name, envir = .GlobalEnv)
  
  # Check if 'cnty_fips' and 'display_name' exist in the data frame
  if(all(c("cnty_fips", "display_name") %in% colnames(df))){
    
    # Convert 'cnty_fips' column to character type
    df$cnty_fips <- as.character(df$cnty_fips)
    
    # Select all columns excluding those with "theme_range" in their name
    df <- df %>%
      select(-contains("theme_range"))

    # Rename each variable, except 'cnty_fips' and 'display_name', to include the data frame name
    df <- df %>%
      rename_with(.cols = -c(cnty_fips, display_name),
                  .fn = ~ paste(df_name, ., sep = "_"))
    
    # Join the data frame with the final data frame
    if (nrow(cdc) == 0){
      cdc <- df
    } 
    else {
      cdc <- full_join(cdc, df, by = c("cnty_fips", "display_name"))
      
      # Remove the ".x" from the column names
      names(cdc) <- gsub("\\.x$", "", names(cdc))
      
      # Remove the "_Value" from the column names
      names(cdc) <- gsub("\\_Value$", "", names(cdc))
    }
  }
}

```


### Renaming variables
```{r}
# Mapping of original names to new names
name_mapping <- c("cnty_fips" = "fips",
                  "display_name" = "display_name",
                  "SEED-UR-Urban-Rural" = "UrbanRural",
                 "SEED-SE-Unemployment_Rate" = "Unemploy",
                 "SEED-SE-Severe_Housing_Cost_Burden"= "HouseCostBurd",
                 "SEED-SE-Poverty" = "Poverty",
                 "SEED-SE-Median_Household_Income" = "MedHouseIncome",
                 "SEED-SE-Median_Home" = "MedHomeValue",
                 "SEED-SE-Income_Inequality" = "IncomeInequality",
                 "SEED-SE-Food_Stamp_SNAP_recipients" = "SNAPrecipients",
                 "SEED-SE-Education-LessThanHighSchool" = "EdLessHigh",
                 "SEED-SE-Education-LessThanCollege" = "EdLessColl",
                 "SEED-SE-Computer" = "Computer",
                 "SEED-SE-Broadband" = "Broadband",
                 "SEED-PE-Park_Access" = "Parks",
                 "SEED-PE-Air_Quality" = "AirQuality",
                 "RF-Smoking" = "Smoker",
                 "RF-Physical_Inactivity" = "PhysInactivity",
                 "RF-Obesity" = "Obesity",
                 "RF-High_Cholesterol" = "HighChol",
                 "RF-Diagnosed_Diabetes" = "Diabetes",
                 "Prev-Stroke" = "Stroke",
                 "Prev-High_Blood_Pressure" = "HighBP",
                 "Prev-Coronary_Heart_Disease" = "CHD",
                 "HCDI-PS-PCP" = "PrimaryCarePhys",
                 "HCDI-PS-Neurosurgeons" = "NeuroSurgeons",
                 "HCDI-PS-Neurologists" = "Neuologists",
                 "HCDI-PS-CDP" = "CardioPhys",
                 "HCDI-Insurance-Health_Insurance_Status" = "HealthIns",
                 "HCDI-HP-Pharmacies_and_Drug_Stores" = "Pharmacies",
                 "HCDI-HP-Hospitals-Services-NS" = "HospNeuro",
                 "HCDI-HP-Hospitals-Services-ED" = "HospED",
                 "HCDI-HP-Hospitals-Services-CIC" = "HospCIC",
                 "HCDI-HP-Hospitals-Services-CR" = "HospCR",
                 "HCDI-HP-Hospitals" = "Hospitals",
                 "HCDI-CRU-Participation_Among_Eligible" = "cruParticipate",
                 "HCDI-CRU-Eligibility_Rate" = "CholMedElegible",
                 "HCDI-CLM-Nonadherence" = "CholMedNonAdhear",
                 "HCDI-Cholesterol_Screening" = "CholScreen",
                 "HCDI-BPM-Medication_Use" = "bpmUse",
                 "Demo-Total_Population" = "Population")

# Get the column names of the data frame
original_names <- colnames(cdc)

# Find the corresponding new names using the mapping
new_names <- name_mapping[match(original_names, names(name_mapping))]

# Rename the variables in the data frame
colnames(cdc) <- new_names

# Clean up global environment
keep(cdc, sure = TRUE)

```


### Make backup and display first few rows
```{r}
cdc_copy <- cdc

head(cdc)

#cdc <- cdc_copy

```

## Data cleansing 
### Removing US territories
```{r}
#cdc <- cdc_copy
cdc <- cdc %>%
  filter(!grepl("\\(AS\\)|\\(GU\\)|\\(MP\\)|\\(PR\\)|\\(County Equivalent\\)", as.character(display_name)))

```


### Separated County and State
```{r}
# Separate the 'display_name' column
cdc <- cdc %>% separate(display_name, into = c("county", "state"), sep = ", \\(|\\)", remove = TRUE, convert = TRUE)

# Remove the closing parenthesis from the state column
cdc$state <- gsub("\\)", "", cdc$state)

# Remove the quotation marks from the 'county' column
cdc$county <- gsub("\"", "", cdc$county)

print(cdc)

```


### Relabeling Urban/Rural codes
```{r}
#change rural/urban
# 1 = Large central metro -> Large_Urban
# 2 = Large fringe metro -> LargeFringe_Urban
# 3 = Medium/small metro -> MediumSmall_Urban
# 4 = Nonmetro -> Rural

cdc$"UrbanRural" <-
    ifelse(cdc$"UrbanRural" == 1,
           "Large_Urban",
    ifelse(cdc$"UrbanRural" == 2,
           "LargeFringe_Urban",
    ifelse(cdc$"UrbanRural" == 3,
           "MediumSmall_Urban",
    ifelse(cdc$"UrbanRural" == 4,
           "Rural",
           cdc$"UrbanRural"))))

### Replacing '-1' with 'NA' under assumption that these are truly missing elements
cdc[cdc == -1] <- NA

```


### Review header names, check for missing rural/urban values
```{r}
names(cdc)

unique(cdc$'UrbanRural')

rural_query <- filter(cdc, `UrbanRural` %in% c(NA, "", "NA"))

head(rural_query, n=20)

```


### Imputing Rural/Urban for missing value
```{r}
# Find and impute where county is 'Kusilvak'
cdc$"UrbanRural"[grepl("Kusilvak", cdc$county)] <- "Rural"

unique(cdc$'UrbanRural')

# Double check for any NAs in Rural/Urban
rural_query <- filter(cdc, `UrbanRural` %in% c(NA, "", "NA"))
head(rural_query, n=20)

```


### Checking for missing values
```{r}
#total number of missing values in dataset
sum(is.na(cdc))

#total number of missing values in each column
colSums(is.na(cdc))

#total number of missing values in each column
count_na_func <- function(x) sum(is.na(x)) 
cdc <- cdc %>%
  mutate(count_na = apply(., 1, count_na_func)) %>% 
  filter(count_na > 0) %>% 
  arrange(desc(count_na))

```


### Remove counties with minimal data
```{r}
# Remove those that have more than 8 NAs in that row
cdc <- cdc[cdc$count_na <= 8, ]

# Remove count_na column
cdc$count_na <- NULL

```


### Export cleaned data to csv
```{r}
# Write data to local in csv format
write_csv(cdc, "data/CDC_all.csv")  

```


## EDA

### Show basic details and information
```{r}
head(cdc)
str(cdc)
dim(cdc)
summary(cdc)
skim(cdc)

```


### Reviewing CHD prevalence
```{r}
hist(cdc$"CHD")

#Why are some prevalence values -1? Let's look at them. Maybe it's a non-reporting issue?
sort(unique(cdc$"CHD"))
chd_query <- filter(cdc, "CHD" 
                    %in% c(NA, "", "NA", NULL))

head(chd_query, n=20)

top_10 <- top_n(cdc, n=10, "CHD")
top_10

bottom_10 <- cdc %>%
    arrange("CHD") %>%
    tail(10)

```

### Top 10 Counties with highest CHD prevalence
```{r}
#returns all of the observations
highest_10 <- top_n(cdc, n=10, "CHD")
highest_10 %>%
    arrange(desc("CHD"))

#tried this. this worked.
highest_10 <- cdc %>%
  arrange(desc("CHD")) %>%
  head(10)
highest_10

```
### Bottom 10 Counties with lowest CHD prevalence
```{r}

lowest_10 <- cdc %>%
#    filter("CHD" != -1) %>%
    arrange("CHD") %>%
    head(10)
lowest_10

```

### Correlation
```{r}
plot_correlation(cdc)


#tried this but needed to remove non numerical first
correlation_matrix <- cdc %>% select(-c(fips, county, state, "UrbanRural")) %>% cor()

#install.packages("reshape2")
library(reshape2)

melted_cor <- melt(correlation_matrix)

ggplot(data = melted_cor, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Correlation Heatmap")

#focused on looking at high correlations only
high_correlations <- subset(melt(correlation_matrix), value > 0.75)

ggplot(data = high_correlations, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "High Correlation Heatmap (Correlation > 0.75)")

#focused on less high correlations
mid_correlations <- subset(melt(correlation_matrix), value > 0.50 & value < 0.75)

ggplot(data = mid_correlations, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Mid Correlation Heatmap (0.50 < Correlation < 0.75)")


#looked at Urban Rural vs CHD
ggplot(data = cdc, aes(x = `UrbanRural`, y = `CHD`, fill = `UrbanRural`)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "UrbanRural", y = "Prevalence of CHD", fill = "UrbanRural") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```


### Auto EDA report
```{r}
# 
# cdc %>%
#     create_report(
#         output_file = paste ("Report", format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z"), sep=" - "),
#         report_title = "EDA Report - CHD Dataset",
#         y = "cardio"
#     )

```


## EDA GGally
## Correlation plots: CHD and Urban/Rural vs various factors
### Prevalence of other heart conditions factors
```{r}
cdc %>%
    select("CHD",
           "HighBP",
           "Stroke",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Hospitals and pharmacy access factors
```{r}
cdc %>%
    select("CHD",
            "Hospitals",
            "Pharmacies",
            "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Hospital services factors
```{r}
cdc %>%
    select("CHD",
            "HospCR",
            "HospCIC",
            "HospED",
            "HospNeuro",
            "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Physician and specialist access factors
```{r}
cdc %>%
    select("CHD",
           "CardioPhys",
           "Neuologists",
           "NeuroSurgeons",
           "PrimaryCarePhys",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Various health care delivery and insurance factors
```{r}
cdc %>%
    select("CHD",
           "bpmUse",
           "CholScreen",
           "CholMedNonAdhear",
           "CholMedElegible",
           "cruParticipate",
           "HealthIns",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Various (physical activity/smoking) risk factors
```{r}
cdc %>%
    select("CHD",
           "PhysInactivity",
           "Smoker",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Various (other diagnosed)risk factors
```{r}
cdc %>%
    select("CHD",
           "Diabetes",
           "HighChol",
           "Obesity",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Various physical environment factors
```{r}
cdc %>%
    select("CHD",
           "AirQuality",
           "Parks",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Various (income) social environmental factors
```{r}
cdc %>%
    select("CHD",
           "SNAPrecipients",
           "IncomeInequality",
           "Poverty",
           "Unemploy",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))
```


### Various (housing) social environmental factors
```{r}
cdc %>%
    select("CHD",
           "MedHomeValue",
           "MedHouseIncome",
           "HouseCostBurd",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))
```


### Various (Education) social environmental factors
```{r}
cdc %>%
    select("CHD",
           "Broadband",
           "Computer",
           "EdLessColl",
           "EdLessHigh",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))
```



# New EDA (not useful as it is primarily a tool for data compression and visualization, also too many NAs)
### Prepare data for principle component analysis
```{r}
# Remove non-numeric variables
cdc_comp <- cdc %>% 
  select(-c("fips", "county", "state", "UrbanRural"))

# Remove NAs
cdc_comp[is.na(cdc_comp)] <- 0

# Double check to see if all entries are finite
all(sapply(cdc_comp, is.finite))

```

#PCA
###* Run PCA on the dataset.
```{r results='hide'}
pr_cdc <- prcomp(x = cdc_comp, scale = T, center = T)

summary(pr_cdc)

```

