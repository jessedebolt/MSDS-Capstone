---
title: "CDC Data ETL"
author: "Jesse DeBolt & Isaac Johnson"
date: "`r Sys.Date()`"
output: html_document
---

### Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# Load the necessary libraries
library(tidyverse)
library(googledrive)
library(gdata)

library(skimr)
library(DataExplorer)
library(GGally)

```


### Establish connection to Google drive containing data
```{r}
folder <- drive_get("~/CapstoneData") # In console, enter "1". In popup select account, then make sure allow checkbox is selected and continue.

all_files <- drive_ls(folder)

```


### Read in all files from Google drive and instert into each as data frames into the global environment
```{r }
# Loop through each row of the all_files dataframe
for (i in 1:nrow(all_files)) {
  # Get the file ID from the current row
  file_id <- as.character(all_files$id[i])

  # Retrieve the file object from Google Drive
  file <- drive_get(as_id(file_id))

  # Define a temporary file path
  temp_file_path <- tempfile()

  # Download the file to a temporary location
  drive_download(file, path = temp_file_path, overwrite = TRUE)

  # Read the downloaded file into a data frame
  df <- read_csv(temp_file_path)

  # Assign the data frame to a new variable in the global environment
  # Remove the file extension (.csv) from the file name before using it as a variable name
  assign(gsub("\\.csv$", "", all_files$name[i]), df, envir = .GlobalEnv)
}

# Clean up global environment
rm(all_files,df,file,folder,file_id,i,temp_file_path)

```


### Merge all sets together into one data frame
```{r}
# Get all the data frame names in the global environment
df_names <- ls(.GlobalEnv)

# Initialize an empty data frame for the final result
cdc <- data.frame()

# Loop through each data frame
for (df_name in df_names) {
  
  # Get the data frame
  df <- get(df_name, envir = .GlobalEnv)
  
  # Check if 'cnty_fips' and 'display_name' exist in the data frame
  if(all(c("cnty_fips", "display_name") %in% colnames(df))){
    
    # Select all columns excluding those with "theme_range" in their name
    df <- df %>%
      select(-contains("theme_range"))
    
    # Rename each variable, except 'cnty_fips' and 'display_name', to include the data frame name
    df <- df %>%
      rename_with(.cols = -c(cnty_fips, display_name),
                  .fn = ~ paste(df_name, ., sep = "_"))
    
    # Join the data frame with the final data frame
    if (nrow(cdc) == 0){
      cdc <- df
    } else {
      cdc <- full_join(cdc, df, by = c("cnty_fips", "display_name"))
      
      # Remove the ".x" from the column names
      names(cdc) <- gsub("\\.x$", "", names(cdc))
      
      # Remove the "_Value" from the column names
      names(cdc) <- gsub("\\_Value$", "", names(cdc))
    }
  }
}

# Clean up global environment
keep(cdc, sure = TRUE)

```


```{r}
head(cdc)

```

### Cleaning up some variables
```{r}
#change rural/urban
# 1 = Large central metro -> Large_Urban
# 2 = Large fringe metro -> LargeFringe_Urban
# 3 = Medium/small metro -> MediumSmall_Urban
# 4 = Nonmetro -> Rural

cdc$`SEED-UR-Urban-Rural` <- ifelse(cdc$`SEED-UR-Urban-Rural`
                                         == 1, "Large_Urban",
                                  ifelse(cdc$`SEED-UR-Urban-Rural`
                                         == 2,"LargeFringe_Urban",
                                  ifelse(cdc$`SEED-UR-Urban-Rural` 
                                         == 3,"MediumSmall_Urban", 
                                  ifelse(cdc$`SEED-UR-Urban-Rural`
                                         == 4,"Rural",
                                  cdc$`SEED-UR-Urban-Rural`))))

### Replacing '-1' with 'NA' under assumption that these are truly missing elements
cdc[cdc == -1] <- NA

```


### Export complete dataframe to csv
```{r}
# Write data to local in csv format
write_csv(cdc, "CDC_all.csv")  

# Establish drive location to copy to
folder <- drive_get("~/CapstoneDataFinal")

# Copy file to Google drive folder
drive_upload("CDC_all.csv", path = folder)

```

# ||||||||||||||||||||||||||||||||||
# |||||||||||||| EDA |||||||||||||||
## ||||||| From cdc_data.Rmd |||||||
# ||||||||||||||||||||||||||||||||||


### EDA (Initial look)
```{r}
head(cdc)
str(cdc)
dim(cdc)
summary(cdc)
skim(cdc)

```

### Any missing values?
```{r}

#total number of missing values in each column
colSums(is.na(cdc))

#total number of missing values in dataset
sum(is.na(cdc))

```


### EDA (rural values?)
```{r}

names(cdc)
unique(cdc$'SEED-UR-Urban-Rural')
rural_query <- filter(cdc, 'SEED-UR-Urban-Rural' == -1)
head(rural_query, n=20)
#should we drop the -1 values, they are technically. not US counties, but territories of US etc...VERIFY
```
##EDA - Let's pook at CHD prevalence
```{r}
hist(cdc$`Prev-Coronary_Heart_Disease`)

#Why are some prevalence values -1? Let's look at them. Maybe it's a non-reporting issue?
sort(unique(cdc$`Prev-Coronary_Heart_Disease`))
chd_query <- filter(cdc, `Prev-Coronary_Heart_Disease` == -1)
head(chd_query, n=20)

top_10 <- top_n(cdc, n=10, `Prev-Coronary_Heart_Disease`)
top_10

bottom_10 <- cdc %>%
    arrange(`Prev-Coronary_Heart_Disease`) %>%
    tail(10)

```

##EDA 10 Counties with highest CHD prevalence
```{r}

highest_10 <- top_n(cdc, n=10, `Prev-Coronary_Heart_Disease`)
highest_10 %>%
    arrange(desc(`Prev-Coronary_Heart_Disease`))

```
##EDA 10 Counties with lowest CHD prevalence
```{r}

lowest_10 <- cdc %>%
    filter(`Prev-Coronary_Heart_Disease` != -1) %>%
    arrange(`Prev-Coronary_Heart_Disease`) %>%
    head(10)
lowest_10

```

##EDA Correlation
```{r}

plot_correlation(cdc)

```


##EDA (auto EDA report)
```{r}

cdc %>%
    create_report(
        output_file = paste ("Report", format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z"), sep=" - "),
        report_title = "EDA Report - CHD Dataset",
        y = "cardio"
    )

```

##EDA GGally
```{r}

cdc %>%
    select(`Prev-Coronary_Heart_Disease`, `Prev-High_Blood_Pressure`, `Prev-Stroke`, 'SEED-UR-Urban-Rural') %>%
    ggpairs(mapping = aes(color = cdc$'SEED-UR-Urban-Rural', alpha = 0.5))

```
