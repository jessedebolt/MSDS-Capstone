---
title: "CDC Data ETL"
author: "Jesse DeBolt & Isaac Johnson"
date: "`r Sys.Date()`"
output: html_document
---


# Primary Document for all code
## Setup
### Load libraries and knit setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# Load the necessary libraries
library(httr)
library(readr)
library(tidyverse)
library(gdata)
library(skimr)
library(DataExplorer)
library(GGally)
library(caret)

```


### Files located in the GitHub repository data folder
```{r}
# File names list
filenames <- c("SEED-UR-Urban-Rural.csv",
               "SEED-SE-Unemployment_Rate.csv",
#               "SEED-SE-Severe_Housing_Cost_Burden.csv", #REMOVE, not relevant.
               "SEED-SE-Poverty.csv",
               "SEED-SE-Median_Household_Income.csv",
               "SEED-SE-Median_Home_Value.csv",
#               "SEED-SE-Income_Inequality.csv", #REMOVE, SEED-SE-Poverty.csv acts as proxy.
               "SEED-SE-Food_Stamp_SNAP_recipients.csv",
#               "SEED-SE-Education-LessThanHighSchool.csv", #REMOVE, SEED-SE-Education-LessThanCollege.csv acts as proxy.
               "SEED-SE-Education-LessThanCollege.csv",
#               "SEED-SE-Computer.csv", #REMOVE, SEED-SE-Broadband.csv acts as proxy.
               "SEED-SE-Broadband.csv",
               "SEED-PE-Park_Access.csv", #REMOVE?
               "SEED-PE-Air_Quality.csv", #REMOVE?
               "RF-Smoking.csv",
               "RF-Physical_Inactivity.csv",
               "RF-Obesity.csv",
               "RF-High_Cholesterol.csv",
               "RF-Diagnosed_Diabetes.csv",
               "Prev-Stroke.csv",
               "Prev-High_Blood_Pressure.csv",
               "Prev-Coronary_Heart_Disease.csv",
               "HCDI-PS-PCP.csv",
#               "HCDI-PS-Neurosurgeons.csv", #REMOVE, not relevant.
#               "HCDI-PS-Neurologists.csv", #REMOVE, not relevant.
               "HCDI-PS-CDP.csv",
#               "HCDI-Insurance-Health_Insurance_Status.csv", #REMOVE, not relevant.
               "HCDI-HP-Pharmacies_and_Drug_Stores.csv",
#               "HCDI-HP-Hospitals-Services-NS.csv", #REMOVE, not relevant.
               "HCDI-HP-Hospitals-Services-ED.csv",
               "HCDI-HP-Hospitals-Services-CIC.csv",
               "HCDI-HP-Hospitals-Services-CR.csv",
               "HCDI-HP-Hospitals.csv",
               "HCDI-CRU-Participation_Among_Eligible.csv",
               "HCDI-CRU-Eligibility_Rate.csv",
               "HCDI-CLM-Nonadherence.csv",
               "HCDI-Cholesterol_Screening.csv",
               "HCDI-BPM-Medication_Use.csv"#,
#               "Demo-Total_Population.csv", #REMOVE, not relevant.
               )

```


### Create a function to generate the URL for a given filename
```{r}
generate_url <- function(filename) {
  return(paste0("https://raw.githubusercontent.com/jessedebolt/MSDS-Capstone/main/data_raw/", filename))
}

```


### Generate urls for each filename
```{r}
urls <- sapply(filenames, generate_url)

```


### Read the CSV files into a list of data frames
```{r }
# Read the CSV files into a list of data frames
df_list <- lapply(urls, read_csv)

# Create names for the list items (remove the .csv from the filenames)
names(df_list) <- sapply(filenames, function(filename) gsub(".csv", "", filename))

# Create individual data frames
list2env(df_list, .GlobalEnv)

```


### Merge all sets together into one data frame
```{r}
# Get all the data frame names in the global environment
df_names <- ls(.GlobalEnv)

# Initialize an empty data frame for the final result
cdc <- data.frame()

# Loop through each data frame
for (df_name in df_names) {
  
  # Get the data frame
  df <- get(df_name, envir = .GlobalEnv)
  
  # Check if 'cnty_fips' and 'display_name' exist in the data frame
  if(all(c("cnty_fips", "display_name") %in% colnames(df))){
    
    # Convert 'cnty_fips' column to character type
    df$cnty_fips <- as.character(df$cnty_fips)
    
    # Select all columns excluding those with "theme_range" in their name
    df <- df %>%
      select(-contains("theme_range"))

    # Rename each variable, except 'cnty_fips' and 'display_name', to include the data frame name
    df <- df %>%
      rename_with(.cols = -c(cnty_fips, display_name),
                  .fn = ~ paste(df_name, ., sep = "_"))
    
    # Join the data frame with the final data frame
    if (nrow(cdc) == 0){
      cdc <- df
    } 
    else {
      cdc <- full_join(cdc, df, by = c("cnty_fips", "display_name"))
      
      # Remove the ".x" from the column names
      names(cdc) <- gsub("\\.x$", "", names(cdc))
      
      # Remove the "_Value" from the column names
      names(cdc) <- gsub("\\_Value$", "", names(cdc))
    }
  }
}

```


### Renaming variables
```{r}
# Mapping of original names to new names
name_mapping <- c("cnty_fips" = "fips",
                  "display_name" = "display_name",
                  "SEED-UR-Urban-Rural" = "UrbanRural",
                 "SEED-SE-Unemployment_Rate" = "Unemploy",
#                 "SEED-SE-Severe_Housing_Cost_Burden"= "HouseCostBurd",
                 "SEED-SE-Poverty" = "Poverty",
                 "SEED-SE-Median_Household_Income" = "MedHouseIncome",
                 "SEED-SE-Median_Home" = "MedHomeValue",
#                 "SEED-SE-Income_Inequality" = "IncomeInequality",
                 "SEED-SE-Food_Stamp_SNAP_recipients" = "SNAPrecipients",
#                 "SEED-SE-Education-LessThanHighSchool" = "EdLessHigh",
                 "SEED-SE-Education-LessThanCollege" = "EdLessColl",
#                 "SEED-SE-Computer" = "Computer",
                 "SEED-SE-Broadband" = "Broadband",
                 "SEED-PE-Park_Access" = "Parks",
                 "SEED-PE-Air_Quality" = "AirQuality",
                 "RF-Smoking" = "Smoker",
                 "RF-Physical_Inactivity" = "PhysInactivity",
                 "RF-Obesity" = "Obesity",
                 "RF-High_Cholesterol" = "HighChol",
                 "RF-Diagnosed_Diabetes" = "Diabetes",
                 "Prev-Stroke" = "Stroke",
                 "Prev-High_Blood_Pressure" = "HighBP",
                 "Prev-Coronary_Heart_Disease" = "CHD",
                 "HCDI-PS-PCP" = "PrimaryCarePhys",
#                 "HCDI-PS-Neurosurgeons" = "NeuroSurgeons",
#                 "HCDI-PS-Neurologists" = "Neurologists",
                 "HCDI-PS-CDP" = "CardioPhys",
                 #"HCDI-Insurance-Health_Insurance_Status" = "HealthIns",
                 "HCDI-HP-Pharmacies_and_Drug_Stores" = "Pharmacies",
#                 "HCDI-HP-Hospitals-Services-NS" = "HospNeuro",
                 "HCDI-HP-Hospitals-Services-ED" = "HospED",
                 "HCDI-HP-Hospitals-Services-CIC" = "HospCIC",
                 "HCDI-HP-Hospitals-Services-CR" = "HospCR",
                 "HCDI-HP-Hospitals" = "Hospitals",
                 "HCDI-CRU-Participation_Among_Eligible" = "cruParticipate",
                 "HCDI-CRU-Eligibility_Rate" = "CholMedElegible",
                 "HCDI-CLM-Nonadherence" = "CholMedNonAdhear",
                 "HCDI-Cholesterol_Screening" = "CholScreen",
                 "HCDI-BPM-Medication_Use" = "bpmUse"#,
#                 "Demo-Total_Population" = "Population"
)

# Get the column names of the data frame
original_names <- colnames(cdc)

# Find the corresponding new names using the mapping
new_names <- name_mapping[match(original_names, names(name_mapping))]

# Rename the variables in the data frame
colnames(cdc) <- new_names

# Clean up global environment
keep(cdc, sure = TRUE)

```


### Make backup and display first few rows
```{r}
cdc_copy <- cdc

head(cdc)

#cdc <- cdc_copy

```

## Data cleansing 
### Removing US territories
```{r}
#Use if needed to back up changes
#cdc <- cdc_copy

#Remove territories
cdc <- cdc %>%
  filter(!grepl("\\(AS\\)|\\(GU\\)|\\(MP\\)|\\(PR\\)|\\(County Equivalent\\)", as.character(display_name)))

```


### Separated County and State
```{r}
# Separate the 'display_name' column
cdc <- cdc %>% separate(display_name, into = c("county", "state"), sep = ", \\(|\\)", remove = TRUE, convert = TRUE)

# Remove the closing parenthesis from the state column
cdc$state <- gsub("\\)", "", cdc$state)

# Remove the quotation marks from the 'county' column
cdc$county <- gsub("\"", "", cdc$county)

print(cdc)

```


### Relabeling Urban/Rural codes
```{r}
#change rural/urban
# 1 = Large central metro -> Large_Urban
# 2 = Large fringe metro -> LargeFringe_Urban
# 3 = Medium/small metro -> MediumSmall_Urban
# 4 = Nonmetro -> Rural

cdc$"UrbanRural" <-
    ifelse(cdc$"UrbanRural" == 1,
           "Large_Urban",
    ifelse(cdc$"UrbanRural" == 2,
           "LargeFringe_Urban",
    ifelse(cdc$"UrbanRural" == 3,
           "MediumSmall_Urban",
    ifelse(cdc$"UrbanRural" == 4,
           "Rural",
           cdc$"UrbanRural"))))

### Replacing '-1' with 'NA' under assumption that these are truly missing elements
cdc[cdc == -1] <- NA

```


### Review header names, check for missing rural/urban values
```{r}
names(cdc)

unique(cdc$'UrbanRural')

rural_query <- filter(cdc, `UrbanRural` %in% c(NA, "", "NA"))

head(rural_query, n=20)

```


### Inserting Rural/Urban for missing value
```{r}
# Find and insert where county is 'Kusilvak' based on Wikipedia data.
cdc$"UrbanRural"[grepl("Kusilvak", cdc$county)] <- "Rural"

unique(cdc$'UrbanRural')

# Double check for any NAs in Rural/Urban
rural_query <- filter(cdc, `UrbanRural` %in% c(NA, "", "NA"))
head(rural_query, n=20)

```


### Inserting Parks missing value
```{r}
# Find and insert where county is 'Kusilvak' based on average for all AK counties.
cdc$"Parks"[grepl("Kusilvak", cdc$county)] <- 66

```



### Checking for missing values
```{r}
#total number of missing values in dataset
sum(is.na(cdc))

#total number of missing values in each column
colSums(is.na(cdc))

#total number of missing values in each column
count_na_func <- function(x) sum(is.na(x)) 
cdc <- cdc %>%
  mutate(count_na = apply(., 1, count_na_func)) %>% 
  arrange(desc(count_na))

```


### Remove counties with minimal data
```{r}
# Remove those that have more than 8 NAs in that row
cdc <- cdc[cdc$count_na <= 8, ]

# Remove count_na column
cdc$count_na <- NULL

```


## Populating missing values
## Single value entry
### Inserting value for missing values in bpmUse for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"bpmUse"[grepl("NJ", cdc$state)] <- 71.71

```
Source: Average of NJ Cities from
500_Cities: Taking medicine for high blood pressure control among adults aged >=18 Years with high blood pressure
File: 500_Cities__Taking_medicine_for_high_blood_pressure_control_among_adults_aged___18_years_with_high_blood_pressure.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-Taking-medicine-for-high-blood-pressure/4peq-qp55


### Inserting value for missing values in CholScreen for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"CholScreen"[grepl("NJ", cdc$state)] <- 79.43

```
Source: Average of NJ Cities from
500 Cities: Cholesterol screening among adults aged >=18 years
FIle: 500_Cities__Cholesterol_screening_among_adults_aged___18_years.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-Cholesterol-screening-among-adults-aged/myk4-ptre


### Inserting value for missing values in HighBP for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"HighBP"[grepl("NJ", cdc$state)] <- 33.7

```
Source: Average of NJ Cities from
500 Cities: High blood pressure among adults aged >=18 years
File: 500_Cities__High_blood_pressure_among_adults_aged___18_years.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-High-blood-pressure-among-adults-aged-1/ebxs-yc6e


### Inserting value for missing values in Diabetes for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"Diabetes"[grepl("NJ", cdc$state)] <- 17.4

```
Source: Average of NJ Cities from
500 Cities: Diagnosed diabetes among adults aged >=18 years
File: 500_Cities__Diagnosed_diabetes_among_adults_aged___18_years.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-Diagnosed-diabetes-among-adults-aged-18/cn78-b9bj


### Inserting value for missing values in HighChol for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"HighChol"[grepl("NJ", cdc$state)] <- 32.41

```
Source: Average of NJ Cities from
500 Cities: High cholesterol among adults aged >=18 years who have been screened in the past 5 years
File:500_Cities__High_cholesterol_among_adults_aged___18_years_who_have_been_screened_in_the_past_5_years.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-High-cholesterol-among-adults-aged-18-y/mc6z-sjie


### Inserting value for missing values in Obesity for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"Obesity"[grepl("NJ", cdc$state)] <- 33.59

```
Source: Average of NJ Cities from
500 Cities: Obesity among adults aged >=18 years
File: 500_Cities__Obesity_among_adults_aged___18_years.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-Obesity-among-adults-aged-18-years/bjvu-3y7d


## Multiple value entry
### Inserting value for missing values in PrimaryCarePhys
```{r}

```
File: Medicare_Physician_Other_Practitioners_by_Provider_2021-Gen_Prac.xlsx


### Inserting value for missing values in CardioPhys
```{r}

```
File: Medicare_Physician_Other_Practitioners_by_Provider_2021-Cardio.xlsx


## Imputations
### Imputing missing values in CholMedNonAdhear
```{r}
cdc = cdc %>% 
  mutate(CholMedNonAdhear = replace_na(CholMedNonAdhear, median(CholMedNonAdhear, na.rm=TRUE)))

```


### Imputing missing values in CholMedElegible
```{r}
cdc = cdc %>% 
  mutate(CholMedElegible = replace_na(CholMedElegible, median(CholMedElegible, na.rm=TRUE)))

```


### Imputing missing values in cruParticipate
```{r}
cdc = cdc %>% 
  mutate(cruParticipate = replace_na(cruParticipate, median(cruParticipate, na.rm=TRUE)))

```


### Imputing missing values in PhysInactivity
```{r}
cdc = cdc %>% 
  mutate(PhysInactivity = replace_na(PhysInactivity, median(PhysInactivity, na.rm=TRUE)))

```


### Imputing missing values in AirQuality
```{r}
cdc = cdc %>% 
  mutate(AirQuality = replace_na(AirQuality, median(AirQuality, na.rm=TRUE)))

```


### Checking for missing values
```{r}
#total number of missing values in each column
colSums(is.na(cdc))

```


### Export cleaned data to csv
```{r}
# Write data to local in csv format
write_csv(cdc, "data/CDC_all.csv")  

```


## EDA

### Show basic details and information
```{r}
head(cdc)
str(cdc)
dim(cdc)
summary(cdc)
skim(cdc)

```


### Reviewing CHD prevalence
```{r}
hist(cdc$"CHD")

#Why are some prevalence values -1? Let's look at them. Maybe it's a non-reporting issue?
sort(unique(cdc$"CHD"))
chd_query <- filter(cdc, "CHD" 
                    %in% c(NA, "", "NA", NULL))

head(chd_query, n=20)

top_10 <- top_n(cdc, n=10, "CHD")
top_10

bottom_10 <- cdc %>%
    arrange("CHD") %>%
    tail(10)

```

### Top 10 Counties with highest CHD prevalence
```{r}
#returns all of the observations
highest_10 <- top_n(cdc, n=10, "CHD")
highest_10 %>%
    arrange(desc("CHD"))

#tried this. this worked.
highest_10 <- cdc %>%
  arrange(desc("CHD")) %>%
  head(10)
highest_10

```
### Bottom 10 Counties with lowest CHD prevalence
```{r}

lowest_10 <- cdc %>%
#    filter("CHD" != -1) %>%
    arrange("CHD") %>%
    head(10)
lowest_10

```

### Correlation
```{r}
plot_correlation(cdc)


#tried this but needed to remove non numerical first
correlation_matrix <- cdc %>% select(-c(fips, county, state, "UrbanRural")) %>% cor()

#install.packages("reshape2")
library(reshape2)

melted_cor <- melt(correlation_matrix)

ggplot(data = melted_cor, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Correlation Heatmap")

#focused on looking at high correlations only
high_correlations <- subset(melt(correlation_matrix), value > 0.75)

ggplot(data = high_correlations, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "High Correlation Heatmap (Correlation > 0.75)")

#focused on less high correlations
mid_correlations <- subset(melt(correlation_matrix), value > 0.50 & value < 0.75)

ggplot(data = mid_correlations, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Mid Correlation Heatmap (0.50 < Correlation < 0.75)")


#looked at Urban Rural vs CHD
ggplot(data = cdc, aes(x = `UrbanRural`, y = `CHD`, fill = `UrbanRural`)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "UrbanRural", y = "Prevalence of CHD", fill = "UrbanRural") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```


### Auto EDA report
```{r}
# 
# cdc %>%
#     create_report(
#         output_file = paste ("Report", format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z"), sep=" - "),
#         report_title = "EDA Report - CHD Dataset",
#         y = "cardio"
#     )

```


## EDA GGally
## Correlation plots: CHD and Urban/Rural vs various factors
### Prevalence of other heart conditions factors
```{r}
cdc %>%
    select("CHD",
           "HighBP",
           "Stroke",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Hospitals and pharmacy access factors
```{r}
cdc %>%
    select("CHD",
            "Hospitals",
            "Pharmacies",
            "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Hospital services factors
```{r}
cdc %>%
    select("CHD",
            "HospCR",
            "HospCIC",
            "HospED",
#            "HospNeuro",
            "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Physician and specialist access factors
```{r}
cdc %>%
    select("CHD",
           "CardioPhys",
#           "Neurologists",
#           "NeuroSurgeons",
           "PrimaryCarePhys",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Various health care delivery and insurance factors
```{r}
cdc %>%
    select("CHD",
           "bpmUse",
           "CholScreen",
           "CholMedNonAdhear",
           "CholMedElegible",
           "cruParticipate",
#           "HealthIns",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Various (physical activity/smoking) risk factors
```{r}
cdc %>%
    select("CHD",
           "PhysInactivity",
           "Smoker",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Various (other diagnosed)risk factors
```{r}
cdc %>%
    select("CHD",
           "Diabetes",
           "HighChol",
           "Obesity",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Various physical environment factors
```{r}
cdc %>%
    select("CHD",
           "AirQuality",
           "Parks",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))

```


### Various (income) social environmental factors
```{r}
cdc %>%
    select("CHD",
           "SNAPrecipients",
#           "IncomeInequality",
           "Poverty",
           "Unemploy",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))
```


### Various (housing) social environmental factors
```{r}
cdc %>%
    select("CHD",
           "MedHomeValue",
           "MedHouseIncome",
#           "HouseCostBurd",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))
```


### Various (Education) social environmental factors
```{r}
cdc %>%
    select("CHD",
           "Broadband",
#           "Computer",
           "EdLessColl",
#           "EdLessHigh",
           "UrbanRural") %>%
    ggpairs(mapping = aes(color = cdc$"UrbanRural", alpha = 0.5))
```


# New EDA (not useful as it is primarily a tool for data compression and visualization, also too many NAs)
### Prepare data for principle component analysis
```{r}
# Remove non-numeric variables
cdc_comp <- cdc %>% 
  select(-c("fips", "county", "state", "UrbanRural"))

# Remove NAs
cdc_comp[is.na(cdc_comp)] <- 0

# Double check to see if all entries are finite
all(sapply(cdc_comp, is.finite))

```

#PCA
### Run PCA on the dataset
```{r results='hide'}
pr_cdc <- prcomp(x = cdc_comp, scale = T, center = T)

summary(pr_cdc)

```


#### Additional feature engineering
```{r}
# Backup
cdc_copy_JAD <- cdc

# Convert urban/rural variables to factors
cdc$UrbanRural <- as.factor(cdc$UrbanRural)

# Use one-hot encoding for the 'state' column
cdc <- fastDummies::dummy_cols(cdc, select_columns = 'state')

```


### Boxplot to compare coronary heart disease prevalence in rural and urban areas
```{r}
ggplot(cdc, aes(x=UrbanRural, y=CHD)) + geom_boxplot()

```



### Histogram to understand distribution of cardiovascular providers in rural and urban areas
```{r}
ggplot(cdc, aes(x=CardioPhys)) + geom_histogram(binwidth=10) + facet_grid(~ UrbanRural)

```


### Histogram to understand distribution of primary care providers in rural and urban areas
```{r}
ggplot(cdc, aes(x=PrimaryCarePhys)) + geom_histogram(binwidth=10) + facet_grid(~ UrbanRural)

```


### Histogram to understand distribution of hospitals in rural and urban areas
```{r}
ggplot(cdc, aes(x=Hospitals)) + geom_histogram(binwidth=10) + facet_grid(~ UrbanRural)

```


### Histogram to understand distribution of hospitals with cardiac intensive care centers in rural and urban areas
```{r}
ggplot(cdc, aes(x=HospCIC)) + geom_histogram(binwidth=10) + facet_grid(~ UrbanRural)

```


### Histogram to understand distribution of hospitals with cardiac rehabilitation centers in rural and urban areas
```{r}
ggplot(cdc, aes(x=HospCR)) + geom_histogram(binwidth=10) + facet_grid(~ UrbanRural)

```


### Histogram to understand distribution of pharmacies in rural and urban areas
```{r}
ggplot(cdc, aes(x=Pharmacies)) + geom_histogram(binwidth=10) + facet_grid(~ UrbanRural)

```


# Statistical Analysis

## Correlation Analysis

### Correlation analysis between cardiovascular providers and coronary heart disease prevalence
```{r}
cor.test(cdc$CardioPhys, cdc$CHD)

```


### Correlation analysis between primary care providers and coronary heart disease prevalence
```{r}
cor.test(cdc$PrimaryCarePhys, cdc$CHD)

```


### Correlation analysis between hospitals and coronary heart disease prevalence
```{r}
cor.test(cdc$Hospitals, cdc$CHD)

```


### Correlation analysis between hospitals with cardiac intensive care centers and coronary heart disease prevalence
```{r}
cor.test(cdc$HospCIC, cdc$CHD)

```


### Correlation analysis between hospitals with cardiac rehabilitation centers and coronary heart disease prevalence
```{r}
cor.test(cdc$HospCR, cdc$CHD)

```


### Correlation analysis between pharmacies and coronary heart disease prevalence
```{r}
cor.test(cdc$Pharmacies, cdc$CHD)

```


## Regreassion analysis

### Regression analysis for potential confounders.
```{r}
model <- lm(CHD ~ CardioPhys + Broadband + Smoker + UrbanRural, data = cdc)
summary(model)

```


# Predictive Modeling

### Split the data into training and test sets
```{r}
set.seed(2112)
train_index <- sample(1:nrow(cdc), 0.7 * nrow(cdc))
train_set <- cdc[train_index, ]
test_set <- cdc[-train_index, ]

table(cdc$UrbanRural)

```


### Build a random forest model
```{r}
library(randomForest)

set.seed(2112)

model <- randomForest(CHD ~ Hospitals + Broadband + UrbanRural, data=train_set, ntree=100)

print(model)

```


### Predict on the test set
```{r}
predictions <- predict(model, test_set)

```


## Predictions
### Policy intervention to increases the number of cardiovascular providers providers by 20% in rural areas
```{r}
data_simulation <- cdc
data_simulation[data_simulation$UrbanRural == 'Rural', 'CardioPhys'] <- data_simulation[data_simulation$UrbanRural == 'Rural', 'CardioPhys'] * 1.20

```


### Use the model to predict outcomes with the simulated data
```{r}
predictions_simulation <- predict(model, data_simulation)

```


### Compare the original predictions and the simulated predictions
```{r}
summary(predictions)
summary(predictions_simulation)

```


## more EDA
```{r}
#Histograms for numerical variables
for (col in 2:33) {
  if (is.numeric(cdc[[col]])) {
    hist(cdc[[col]], main = names(cdc)[col])
  } else {
    message(paste("Skipping column", names(cdc)[col], "as it is not numeric."))
  }
}

```
#### Wanted to zoom in hospitals
```{r}
hospital_counts <- cdc$Hospitals  # Assuming "Hospitals" is the column name in the dataset "cdc"

# Filter out hospitals greater than 10 (optional, if needed)
hospital_counts <- hospital_counts[hospital_counts <= 10]

# Create a table of counts for each hospital count
count_table <- table(hospital_counts)

# Create a bar plot to visualize the breakdown
barplot(count_table, main = "Number of Hospitals per County", xlab = "Number of Hospitals", ylab = "Count")

```
#### Same as above but improved visual
```{r}
#Most counties have 1 hospital
hospital_counts <- cdc$Hospitals  # Assuming "Hospitals" is the column name in the dataset "cdc"

# Filter out hospitals greater than 10 (optional, if needed)
hospital_counts <- hospital_counts[hospital_counts <= 10]

# Create a data frame with counts for each hospital count
count_df <- data.frame(Hospitals = as.factor(hospital_counts))
count_summary <- summary(count_df$Hospitals)

# Create a bar plot using ggplot2
ggplot(count_df, aes(x = Hospitals)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Number of Hospitals per County", x = "Number of Hospitals", y = "Count") +
  scale_x_discrete(limits = as.character(0:10)) +
  theme_minimal()

```
#### How many counties have no hospitals
```{r}
# Check the count for zero hospitals
count_zero <- count_table[as.character(0)]

# Print the number of counties with zero hospitals
print(paste("Number of counties with zero hospitals:", count_zero))

```
#### list of counties with 0 hospitals
```{r}
no_hospital <- cdc %>%
  filter(Hospitals == 0) %>%
  select(county, state, Hospitals) %>%
  arrange(state, county)

print(no_hospital)

```
#### How many counties per state
```{r}
county_counts <- cdc %>%
  group_by(state) %>%
  summarise(counties = n())

print(county_counts)

```
####
```{r}
# Average prevalence for the US
us_average <- mean(cdc$CHD, na.rm = TRUE)
us_average <- sprintf("%.1f%%", us_average)

# Average prevalence for each state
state_average <- cdc %>%
  group_by(state) %>%
  summarise(average_CHD = mean(CHD, na.rm = TRUE)) %>%
  mutate(average_CHD = sprintf("%.1f%%", average_CHD))

print(us_average)
print(state_average)

```
#### states with highest and lowest prevalence
```{r}

# Top 10 states with highest prevalence
highest_prevalence <- cdc %>%
  group_by(state) %>%
  summarise(average_CHD = mean(CHD, na.rm = TRUE)) %>%
  arrange(desc(average_CHD)) %>%
  slice(1:10) %>%
  mutate(average_CHD = sprintf("%.1f%%", average_CHD))

# Top 10 states with lowest prevalence
lowest_prevalence <- cdc %>%
  group_by(state) %>%
  summarise(average_CHD = mean(CHD, na.rm = TRUE)) %>%
  arrange(average_CHD) %>%
  slice(1:10) %>%
  mutate(average_CHD = sprintf("%.1f%%", average_CHD))

print(highest_prevalence)
print(lowest_prevalence)

```
#### What is distribution of Urban Rural for Each State
```{r}
#We should maybe bucket these? but not sure if we need to keep as is for model?
urbanrural_counts <- cdc %>%
  group_by(state, UrbanRural) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  arrange(state, desc(UrbanRural)) %>%
  pivot_wider(names_from = UrbanRural, values_from = count, values_fill = 0)

# Define the desired column order
column_order <- c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban", "Rural")

# Reorder the columns
urbanrural_counts <- urbanrural_counts %>%
  select(state, all_of(column_order))

print(urbanrural_counts)
```


#### Visualization - Stacked Bar
```{r}

urbanrural_counts <- cdc %>%
  group_by(state, UrbanRural) %>%
  summarise(count = n()) %>%
  ungroup()

ggplot(urbanrural_counts, aes(x = state, y = count, fill = UrbanRural)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of UrbanRural Variable by State",
       x = "State", y = "Count") +
  scale_fill_discrete(name = "UrbanRural") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```
#### Visualization Bar
```{r}
urbanrural_counts <- cdc %>%
  group_by(state, UrbanRural) %>%
  summarise(count = n()) %>%
  ungroup()

ggplot(urbanrural_counts, aes(x = state, y = count, fill = UrbanRural)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Distribution of UrbanRural Variable by State",
       x = "State", y = "Count") +
  scale_fill_discrete(name = "UrbanRural") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```
#### Top 5 states with most Urban
```{r}
top_large_urban <- cdc %>%
  filter(UrbanRural == "Large_Urban") %>%
  group_by(state) %>%
  summarise(count = n()) %>%
  arrange(count) %>%
  slice_tail(n = 5) %>%
  mutate(state = factor(state, levels = rev(state)))

ggplot(top_large_urban, aes(x = state, y = count, fill = state)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5) +
    labs(title = "Top 5 States with the Most Large Urban Areas",
       x = "State", y = "Count") +
  scale_fill_brewer(palette = "Dark2") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

#### Top 10 states with most Rural
```{r}
top_rural <- cdc %>%
  filter(UrbanRural == "Rural") %>%
  group_by(state) %>%
  summarise(count = n()) %>%
  arrange(count) %>%
  slice_tail(n = 10) %>%
  mutate(state = factor(state, levels = rev(state)))

custom_colors <- c("#FF5733", "#FFC300", "#C70039", "#900C3F", "#581845", "#FF7F50", "#FFA500", "#FFD700", "#ADFF2F", "#00FF00")

ggplot(top_rural, aes(x = state, y = count, fill = state)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5) +
  labs(title = "Top 10 States with the Most Rural Areas",
       x = "State", y = "Count") +
  scale_fill_manual(values = custom_colors) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

#### I like this one better I think
```{r}
# Reverse the color palette
color_func <- colorRampPalette(c("lightblue", "darkblue"))
custom_colors <- rev(color_func(10))

top_rural <- cdc %>%
  filter(UrbanRural == "Rural") %>%
  group_by(state) %>%
  summarise(count = n()) %>%
  arrange(count) %>%
  slice_tail(n = 10) %>%
  mutate(state = factor(state, levels = rev(state)))

ggplot(top_rural, aes(x = state, y = count, fill = state)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5) +
  labs(title = "Top 10 States with the Most Rural Areas",
       x = "State", y = "Count") +
  scale_fill_manual(values = custom_colors) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

#### Top 10 states with most Large Fringe Urban
```{r}
# Create the color palette
color_func <- colorRampPalette(c("lightblue", "darkblue"))
custom_colors <- rev(color_func(10))  # Reverse to get dark colors for higher values

top_large_fringe_urban <- cdc %>%
  filter(UrbanRural == "LargeFringe_Urban") %>%
  group_by(state) %>%
  summarise(count = n()) %>%
  arrange(count) %>%
  slice_tail(n = 10) %>%
  mutate(state = factor(state, levels = rev(state)))

ggplot(top_large_fringe_urban, aes(x = state, y = count, fill = state)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5) +
  labs(title = "Top 10 States with the Most Large Fringe Urban Areas",
       x = "State", y = "Count") +
  scale_fill_manual(values = custom_colors) +  # Use the custom color palette
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))



```

#### Medium Small Urban Areas
```{r}
# Create the color palette
color_func <- colorRampPalette(c("lightblue", "darkblue"))
custom_colors <- rev(color_func(10))  # Reverse to get dark colors for higher values

top_large_fringe_urban <- cdc %>%
  filter(UrbanRural == "MediumSmall_Urban") %>%
  group_by(state) %>%
  summarise(count = n()) %>%
  arrange(count) %>%
  slice_tail(n = 10) %>%
  mutate(state = factor(state, levels = rev(state)))

ggplot(top_large_fringe_urban, aes(x = state, y = count, fill = state)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5) +
  labs(title = "Top 10 States with the Most Medium Small Urban Areas",
       x = "State", y = "Count") +
  scale_fill_manual(values = custom_colors) +  # Use the custom color palette
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))



```

#### Boxplots for each variable
```{r}
# Box plots for each variable
for (i in 1:ncol(cdc_comp)) {
  par(mar = c(5, 4, 2, 1))  # Adjust the margins as needed
  boxplot(cdc_comp[, i], main = names(cdc_comp)[i])
}
```
#### Outliers
```{r}
# Outlier detection
for (column in colnames(cdc_comp)){
  IQR = IQR(cdc_comp[[column]], na.rm = TRUE)
  lower_bound = quantile(cdc_comp[[column]], 0.25, na.rm = TRUE) - 1.5 * IQR
  upper_bound = quantile(cdc_comp[[column]], 0.75, na.rm = TRUE) + 1.5 * IQR
  outliers = length(which(cdc_comp[[column]] < lower_bound | cdc_comp[[column]] > upper_bound))
  print(paste("Number of outliers in", column, ":", outliers))
}
```

#### Just checking where missing values are
```{r}
# Checking for missing values
missing_value_cols <- c()
for (i in 1:ncol(cdc_comp)) {
  if (any(is.na(cdc_comp[, i]))) {
    missing_value_cols <- c(missing_value_cols, names(cdc_comp)[i])
  }
}
cat("Columns with missing values:\n")
print(missing_value_cols)

```

```{r}
cat("Number of NA values in each column:\n")
print(colSums(is.na(cdc_comp)))
```


####Test imputing data that is still missing
```{r}
# Handling missing values (assuming you want to impute them)
library(mice)
imputed_data <- mice(cdc, m = 5)  # Impute missing values (replace 'data' with your dataset)

# Encoding categorical variables (assuming 'urban_rural' is a categorical variable)
#imputed_data$UrbanRural <- as.factor(imputed_data$UrbanRural)

```


#### Interpretation of the below lm model CHD vs Urban Rural

Intercept (Large_Urban): In this model, "Large_Urban" is the reference category because it is represented by the intercept. The intercept's value of approximately 5.79 is the average CHD prevalence in "Large_Urban" areas (given that the CHD data and coefficients are in a format where this interpretation makes sense).

LargeFringe_Urban: The coefficient of approximately 1.01 suggests that, on average, the CHD prevalence in "LargeFringe_Urban" areas is estimated to be about 1.01 units higher than in "Large_Urban" areas.

MediumSmall_Urban: Similarly, the CHD prevalence in "MediumSmall_Urban" areas is estimated to be about 1.80 units higher than in "Large_Urban" areas.

Rural: Lastly, the CHD prevalence in "Rural" areas is estimated to be about 2.98 units higher than in "Large_Urban" areas.

For all categories of "UrbanRural", the p-values are less than 0.05, which suggests that the differences in CHD prevalence between "Large_Urban" areas and the other types of areas are statistically significant.

In other words, your model suggests that there is a significant association between the type of area and CHD prevalence. Specifically, all other types of areas have higher estimated CHD prevalence than "Large_Urban" areas.

```{r}
# Fit models to each imputed dataset
models <- with(imputed_data, exp = lm(CHD ~ UrbanRural))

# Pool results
pooled_results <- pool(models)

# Print summary of pooled results
summary(pooled_results)

```
####Interpretation of LM model CHD vs Urban Rural + HighBP
In your output, each row corresponds to a term in the model, and each column corresponds to an aspect of the term.

- **term**: This is the name of the variable in the model. "(Intercept)" refers to the model's intercept, or baseline outcome when all the predictors are 0. In your case, "UrbanRuralLargeFringe_Urban", "UrbanRuralMediumSmall_Urban", and "UrbanRuralRural" are dummy variables derived from the categorical variable "UrbanRural", and "HighBP" is a variable representing high blood pressure.

- **estimate**: This is the estimated coefficient for the term in the model. For example, the estimate for "HighBP" is 0.1983978. In the context of this model, it means that for each unit increase in "HighBP", we would expect an increase of 0.1983978 units in "CHD", holding all other variables constant.

- **std.error**: This is the standard error of the estimated coefficient. It measures the variability in the estimate. A smaller standard error means the estimate is more precise.

- **statistic**: This is the t-statistic for the term. It is the ratio of the estimate to the standard error. The t-statistic follows a t-distribution under the null hypothesis that the true coefficient is zero. A larger absolute value of the t-statistic means it is further from zero, which provides stronger evidence against the null hypothesis.

- **df**: This is the degrees of freedom for the t-statistic.

- **p.value**: This is the p-value for the hypothesis test of whether the coefficient is zero. A smaller p-value means there is stronger evidence against the null hypothesis, i.e., stronger evidence that the coefficient is not zero.

In your output, all the p-values are very small, which suggests that each term in the model is significantly related to "CHD". Specifically:

- For a county that's "UrbanRuralLargeFringe_Urban" versus "Large_Urban", the expected "CHD" increases by 0.2928782 units, holding all other variables constant.
- For a county that's "UrbanRuralMediumSmall_Urban" versus "Large_Urban", the expected "CHD" increases by 0.7978104 units, holding all other variables constant.
- For a county that's "UrbanRuralRural" versus "Large_Urban", the expected "CHD" increases by 1.4393493 units, holding all other variables constant.
- For each unit increase in "HighBP", the expected "CHD" increases by 0.1983978 units, holding all other variables constant.

Therefore, your model suggests that "HighBP" and "UrbanRural" are both significant predictors of "CHD", with "HighBP" being a particularly strong predictor given its large t-statistic. This matches with what you might expect given that high blood pressure is known to be a risk factor for coronary heart disease.
```{r}
# Fit models to each imputed dataset
models <- with(imputed_data, exp = lm(CHD ~ UrbanRural + HighBP))

# Pool results
pooled_results <- pool(models)

# Print summary of pooled results
summary(pooled_results)

```
####tried many variables in LM
1. **(Intercept)**: The expected value of CHD when all predictor variables are zero. In practice, this might not be meaningful if zero is outside the range of your predictor variables.
   
2. **UrbanRuralLargeFringe_Urban**: This is the change in CHD expected with a change from Large Urban (the reference category) to Large Fringe Urban, keeping all other variables constant. The p-value is slightly more than 0.05, so this effect may not be statistically significant at the usual levels.
   
3. **UrbanRuralMediumSmall_Urban**: This is the change in CHD expected with a change from Large Urban to Medium or Small Urban. The positive coefficient and small p-value suggest this is associated with an increase in CHD, and this effect is statistically significant.
   
4. **UrbanRuralRural**: The expected change in CHD with a change from Large Urban to Rural. This is significantly associated with an increase in CHD.
   
5. **HighBP (High Blood Pressure)**: The expected change in CHD with a unit increase in HighBP. The positive coefficient and very small p-value suggest that higher blood pressure is significantly associated with higher CHD.

6. **Broadband**: I'm not sure what this variable represents, but its positive coefficient and small p-value suggest that an increase in Broadband is associated with an increase in CHD, assuming all other variables are held constant.

7. **Smoker**: This might represent whether the individual is a smoker or the proportion of smokers. The positive coefficient and small p-value suggest that smoking is significantly associated with higher CHD.

8. **EdLessColl (Education Less than College)**: This might represent individuals with less than college education. The positive coefficient and small p-value suggest that having less than college education is significantly associated with higher CHD.

9. **MedHouseIncome (Median Household Income)**: This might represent the median household income in an area. The negative coefficient and very small p-value suggest that higher median household income is significantly associated with lower CHD, assuming all other variables are held constant.

10. **Poverty**: This might represent the proportion of individuals in poverty in an area. The negative coefficient and small p-value suggest that higher poverty is significantly associated with lower CHD, which seems counterintuitive. It might be due to confounding variables or other complex relationships in your data. 

Remember, these interpretations are conditional on the other variables in the model. This means, for example, the effect of HighBP on CHD is estimated assuming all other variables (UrbanRural, Broadband, Smoker, EdLessColl, MedHouseIncome, Poverty) are held constant.

Also, all these interpretations are about associations, not causal relationships. Determining whether a relationship is causal is more complex and requires more than just statistical analysis.
```{r}
# Fit models to each imputed dataset
models <- with(imputed_data, exp = lm(CHD ~ UrbanRural + HighBP + Broadband + Smoker + EdLessColl + MedHouseIncome + Poverty)) 

# Pool results
pooled_results <- pool(models)

# Print summary of pooled results
summary(pooled_results)

```


#### LM with Poverty
- **(Intercept)**: The expected value of CHD when all predictor variables are zero. In the context of your model, this would mean when `UrbanRural` is at its reference level (which I'm assuming is "Large_Urban") and `Poverty` is 0. It's unlikely that the zero value of Poverty has a practical interpretation in your context. So, the intercept here is more of a technical aspect of the model, rather than something you would interpret directly.

- **UrbanRuralLargeFringe_Urban**: This represents the expected change in CHD when the `UrbanRural` variable changes from "Large_Urban" to "LargeFringe_Urban", keeping the `Poverty` constant. The estimate of 1.441820 suggests that, on average, `CHD` is 1.441820 units higher in "LargeFringe_Urban" areas than in "Large_Urban" areas, when `Poverty` is the same in both areas. The p-value of 2.808080e-19 (very close to 0) suggests that this effect is statistically significant.

- **UrbanRuralMediumSmall_Urban**: This represents the expected change in CHD when `UrbanRural` changes from "Large_Urban" to "MediumSmall_Urban", with `Poverty` kept constant. The estimate suggests that, on average, `CHD` is 1.802180 units higher in "MediumSmall_Urban" areas than in "Large_Urban" areas when `Poverty` is the same. The p-value (1.664810e-31) indicates that this effect is statistically significant.

- **UrbanRuralRural**: This represents the expected change in CHD when `UrbanRural` changes from "Large_Urban" to "Rural", keeping `Poverty` constant. The estimate of 2.766099 suggests that `CHD` is, on average, 2.766099 units higher in "Rural" areas than in "Large_Urban" areas when `Poverty` is the same. The p-value (2.199503e-73) indicates this effect is statistically significant.

- **Poverty**: This represents the expected change in CHD for a one-unit increase in `Poverty`, keeping `UrbanRural` constant. The positive estimate of 0.122293 suggests that for each unit increase in `Poverty`, `CHD` increases, on average, by 0.122293 units. The p-value (5.782284e-167) indicates this effect is statistically significant.

Please note that these interpretations are based on associations, not causal relationships. The estimates give us the expected change in the outcome variable (CHD) for a unit change in the predictor variables, assuming all other predictors are held constant. However, they do not tell us whether changing the predictor variable would cause a change in the outcome. Also, be aware that other factors not included in the model could be confounding the relationships.
```{r}
# Fit models to each imputed dataset
models <- with(imputed_data, exp = lm(CHD ~ UrbanRural + Poverty))

# Pool results
pooled_results <- pool(models)

# Print summary of pooled results
summary(pooled_results)
```
####Linear Model with interactions
1. **Intercept:** The intercept of the model is approximately 2.89. In the context of this model, the intercept represents the expected value of CHD when all the predictor variables are 0. However, since some of your variables are categorical (UrbanRural), the interpretation of the intercept becomes less straightforward. 

2. **UrbanRural:** The coefficients for UrbanRural indicate the change in the expected value of CHD for a given level of UrbanRural compared to the reference level (which in this case is "Large_Urban"), while all other predictors remain constant. For example, for "MediumSmall_Urban", the expected CHD decreases by about 1.81 units compared to "Large_Urban", assuming all other variables stay constant. Keep in mind that this coefficient is not statistically significant as the p-value is larger than 0.05.

3. **HighBP:** HighBP is positively associated with CHD, with a one-unit increase in HighBP leading to a ~0.092 increase in the expected value of CHD, assuming all other variables stay constant.

4. **Smoker:** Being a smoker increases the expected value of CHD by about 0.15, assuming all other variables stay constant.

5. **MedHouseIncome:** The coefficient for MedHouseIncome is close to 0 and its p-value is greater than 0.05, suggesting that there is no significant linear relationship between MedHouseIncome and CHD when other variables are controlled.

6. **Broadband, EdLessColl, and Poverty:** Similar to HighBP and Smoker, Broadband and EdLessColl are positively associated with CHD while Poverty is negatively associated. The more detailed interpretation would be similar to what we've gone over for HighBP and Smoker.

7. **Interaction Terms:** The coefficients for the interaction terms represent how much the relationship between HighBP and CHD changes for different levels of UrbanRural and how much the relationship between Smoker and CHD changes for different levels of MedHouseIncome. For instance, the interaction term UrbanRuralMediumSmall_Urban:HighBP suggests that the effect of HighBP on CHD is 0.068 units higher in MediumSmall_Urban areas compared to Large_Urban areas. 

   The interpretation of interaction terms can be complex, especially when the variables involved are not continuous. The main point here is that the relationship between CHD and HighBP and between CHD and Smoker varies depending on the level of UrbanRural and MedHouseIncome, respectively.

Overall, this model provides a nuanced view of the factors influencing CHD. However, it's essential to remember that this is a statistical model that captures associations, not necessarily causal relationships. For instance, while Broadband is positively associated with CHD, we wouldn't conclude that increasing broadband availability causes an increase in coronary heart disease prevalence. The associations we observe could be influenced by a variety of other factors not included in the model.
```{r}
# Fit models to each imputed dataset
models <- with(imputed_data, exp = lm(CHD ~ UrbanRural * HighBP + Smoker * MedHouseIncome + Broadband + EdLessColl + Poverty))

# Pool results
pooled_results <- pool(models)

# Print summary of pooled results
summary(pooled_results)
```




#### Saved the data (can delete this)
```{r}
#write.csv(cdc, "/Users/isaacjohnson/Documents/Scanner Output/School/Willamette/Capstone/Capstone Project/Backup/cdc.csv", row.names = FALSE)
```

#### Proportion for each level of Urban Rural
```{r}

# proportion of each level 'UrbanRural'
urban_rural_proportions <- cdc %>%
  group_by(UrbanRural) %>%
  summarise(n = n()) %>%
  mutate(prop = n / sum(n))

# Print the proportions
print(urban_rural_proportions)

```



#### Mean Prevalence for CHD by each level of Urban/Rural
```{r}

# Compute mean CHD prevalence for each category of UrbanRural
mean_chd <- cdc %>% 
  group_by(UrbanRural) %>% 
  summarise(mean_chd = mean(CHD))

# Print mean CHD prevalence
print(mean_chd)

```

#### Look at extremes for Urban RUral
```{r}
# Find urban areas (Large_Urban, LargeFringe_Urban, MediumSmall_Urban) with high CHD
urban_high_chd <- cdc %>% 
  filter(UrbanRural %in% c('Large_Urban', 'LargeFringe_Urban', 'MediumSmall_Urban'), 
         CHD > quantile(CHD, 0.95))

# Find rural areas with low CHD
rural_low_chd <- cdc %>% 
  filter(UrbanRural == 'Rural', CHD < quantile(CHD, 0.05))

# Print the top 5 urban areas with high CHD
print(head(urban_high_chd, 5))

# Print the top 5 rural areas with low CHD
print(head(rural_low_chd, 5))
```



#### side by side of what's different between the two extremes
```{r}
# Get the names of numeric columns
numeric_columns <- names(cdc)[sapply(cdc, is.numeric)]

# Select the first 29 numeric columns
numeric_columns <- numeric_columns[1:29]

# Compute descriptive statistics for urban areas with high CHD
urban_high_chd_stats <- urban_high_chd %>%
  select(numeric_columns) %>%
  summarise_all(list(mean = mean, sd = sd), na.rm = TRUE)

# Compute descriptive statistics for rural areas with low CHD
rural_low_chd_stats <- rural_low_chd %>%
  select(numeric_columns) %>%
  summarise_all(list(mean = mean, sd = sd), na.rm = TRUE)

# Add a group indicator
urban_high_chd_stats$group <- "urban_high_chd"
rural_low_chd_stats$group <- "rural_low_chd"

# Bind the rows
combined_stats <- bind_rows(urban_high_chd_stats, rural_low_chd_stats)

# Reshape from wide to long format
long_stats <- pivot_longer(combined_stats, -group, names_to = c(".value", "statistic"), names_pattern = "(.+)_(.+)")

# Print the long format stats
print(long_stats)
```




```{r}

# Separate the mean and standard deviation rows
mean_stats <- long_stats %>% filter(statistic == "mean")
sd_stats <- long_stats %>% filter(statistic == "sd")

# Merge the data frames by group and variable names
merged_stats <- merge(mean_stats, sd_stats, by = c("group"), suffixes = c("_mean", "_sd"))

# Plot mean and sd for CHD
ggplot(merged_stats, aes(x = group, y = CHD_mean, fill = group)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin = CHD_mean - CHD_sd, ymax = CHD_mean + CHD_sd), width = 0.2, position = position_dodge(0.9)) +
  labs(title = "Mean and Standard Deviation of CHD", x = "Group", y = "Mean CHD")

```




```{r}
# Select variables
selected_vars <- c("bpmUse", "CholScreen", "Obesity")

# Loop over selected variables
for (var in selected_vars) {
  # Filter data for this variable (mean only)
  var_data <- filter(long_data, variable == paste0(var, "_mean"))
  
  # Create bar plot
  p <- ggplot(var_data, aes(x = group, y = value, fill = group)) +
    geom_bar(stat = "identity", position = position_dodge()) +
    labs(title = paste("Comparison of", var, "between Groups"),
         x = "Group",
         y = "Value") 
  
  # Print plot
  print(p)
}


```




















































####Saving for possible use later
```{r}
# Splitting the data into training and testing sets
#library(caret)
#set.seed(123)  # For reproducibility
#train_indices <- createDataPartition(cdc$target_variable, p = 0.7, list = FALSE)
#train_data <- data[train_indices, ]
#test_data <- data[-train_indices, ]

```

```{r}
# Example of building a linear regression model using caret
#library(caret)
#set.seed(123)  # For reproducibility
#model <- train(target_variable ~ ., data = train_data, method = "lm")  # Replace 'target_variable' with #your target variable/column name

# Model evaluation
#predictions <- predict(model, newdata = test_data)

```





















































































































































































































































































































































































































































































































































































































































































































































































# ***Jesse models, etc start***


### CHD/cardiovascular physicians correlation analysis visualization
```{r}
cdc %>%
  filter(UrbanRural %in% c(unique(UrbanRural))) %>%
ggplot(aes(log(CardioPhys), CHD, color=UrbanRural)) +
geom_point(alpha=0.3)+
facet_wrap(~UrbanRural)+
geom_smooth(method = lm)

```

### CHD/primary care physicians correlation analysis visualization
```{r}
cdc %>%
  filter(UrbanRural %in% c(unique(UrbanRural))) %>%
ggplot(aes(log(PrimaryCarePhys), CHD, color=UrbanRural)) +
geom_point(alpha=0.3)+
facet_wrap(~UrbanRural)+
geom_smooth(method = lm)

```

### CHD/hospitals correlation analysis visualization
```{r}
cdc %>%
  filter(UrbanRural %in% c(unique(UrbanRural))) %>%
ggplot(aes(log(Hospitals), CHD, color=UrbanRural)) +
geom_point(alpha=0.3)+
facet_wrap(~UrbanRural)+
geom_smooth(method = lm)

```


### CHD/cardiac intensive care centers correlation analysis visualization
```{r}
cdc %>%
  filter(UrbanRural %in% c(unique(UrbanRural))) %>%
ggplot(aes(log(HospCIC), CHD, color=UrbanRural)) +
geom_point(alpha=0.3)+
facet_wrap(~UrbanRural)+
geom_smooth(method = lm)

```


### CHD/hospitals with cardiac rehabilitation centers correlation analysis visualization
```{r}
cdc %>%
  filter(UrbanRural %in% c(unique(UrbanRural))) %>%
ggplot(aes(log(HospCR), CHD, color=UrbanRural)) +
geom_point(alpha=0.3)+
facet_wrap(~UrbanRural)+
geom_smooth(method = lm)

```



### CHD/pharmacies correlation analysis visualization
```{r}
cdc %>%
  filter(UrbanRural %in% c(unique(UrbanRural))) %>%
ggplot(aes(log(Pharmacies), CHD, color=UrbanRural)) +
geom_point(alpha=0.3)+
facet_wrap(~UrbanRural)+
geom_smooth(method = lm)

```




```{r}
colSums(is.na(cdc))

```
























































































# REFERENCE INFORMATION
## Name mapping for reference:
| Variable Name | Variable Type | Short Name |
| ------------- | ------------- | ---------- |
| cnty_fips | character | fips |
| display_name | character | display_name |
| SEED-UR-Urban-Rural | Cat | UrbanRural |
| SEED-SE-Unemployment_Rate | Perc | Unemploy |
| SEED-SE-Severe_Housing_Cost_Burden | Perc | HouseCostBurd |
| SEED-SE-Poverty | Perc | Poverty |
| SEED-SE-Median_Household_Income | USD | MedHouseIncome |
| SEED-SE-Median_Home_Value | USD | MedHomeValue |
| SEED-SE-Income_Inequality | Unknown | IncomeInequality |
| SEED-SE-Food_Stamp_SNAP_recipients | Perc | SNAPrecipients |
| SEED-SE-Education-LessThanHighSchool | Perc | EdLessHigh |
| SEED-SE-Education-LessThanCollege | Perc | EdLessColl |
| SEED-SE-Computer | Perc | Computer |
| SEED-SE-Broadband | Perc | Broadband |
| SEED-PE-Park_Access | Perc | Parks |
| SEED-PE-Air_Quality | Annual PM2.5 Level | AirQuality |
| RF-Smoking | Perc | Smoker |
| RF-Physical_Inactivity | Perc | PhysInactivity |
| RF-Obesity | Perc | Obesity |
| RF-High_Cholesterol | Perc | HighChol |
| RF-Diagnosed_Diabetes | Perc | Diabetes |
| Prev-Stroke | Perc | Stroke |
| Prev-High_Blood_Pressure | Perc | HighBP |
| Prev-Coronary_Heart_Disease | Perc | CHD |
| HCDI-PS-PCP | Count | PrimaryCarePhys |
| HCDI-PS-Neurosurgeons | Count | NeuroSurgeons |
| HCDI-PS-Neurologists | Count | Neurologists |
| HCDI-PS-CDP | Count | CardioPhys |
| HCDI-Insurance-Health_Insurance_Status | Perc | HealthIns |
| HCDI-HP-Pharmacies_and_Drug_Stores | Count | Pharmacies |
| HCDI-HP-Hospitals-Services-NS | Count | HospNeuro |
| HCDI-HP-Hospitals-Services-ED | Count | HospED |
| HCDI-HP-Hospitals-Services-CIC | Count | HospCIC |
| HCDI-HP-Hospitals-Services-CR | Count | HospCR |
| HCDI-HP-Hospitals | Count | Hospitals |
| HCDI-CRU-Participation_Among_Eligible | Perc | cruParticipate |
| HCDI-CRU-Eligibility_Rate | RatePer1000 | CholMedElegible |
| HCDI-CLM-Nonadherence | Perc | CholMedNonAdhear |
| HCDI-Cholesterol_Screening | Perc | CholScreen |
| HCDI-BPM-Medication_Use | Perc | bpmUse |
| Demo-Total_Population | Count | Population |
