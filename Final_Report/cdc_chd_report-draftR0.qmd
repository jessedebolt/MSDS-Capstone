---
title: "Healthcare Access and its Effects on Coronary Heart Disease Prevalence"
author:
  - name: "Isaac Johnson & Jesse DeBolt"
    affiliation: "Willamette University School of Computing and Information Sciences"
date: "August 1, 2023"
date-format: "long"
course: DATA510 - Data Science Capstone Project
image: "DATA501_Final.png"
format:
  html:
    toc: true
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(readr)
library(tidyverse)
library(gridExtra)
library(ggthemes)
library(reshape2)
library(GGally)
library(qgraph)
library(corrplot)
library(usmap)

```


```{r load}
cdc_clean <- read_csv("data/cleanCDC.csv")
cdc <- read_csv("../data/CDC_all.csv")

```

```{r}
plot_usmap(data = cdc, values = "CHD") +
  scale_fill_continuous(low = "blue", high = "red", name = "CHD", 
                        label = scales::comma) +
  theme(legend.position = "right") +
  labs(title = "Coronary Heart Disease Prevalence by County")

```

## **ABSTRACT**
This project represents the culmination of our Master of Data Science program at Willamette University's School of Computing & Information Sciences, under the supervision of Dr. Jameson Watts. Serving as a testament to the knowledge and skills we have honed throughout our course, this capstone project required us to plan and execute a comprehensive data science project that holds consequential potential for an organization or society at large.  
  
We chose to focus on a topic of significant personal and societal importance - the impact of disparities in healthcare access on the prevalence of coronary heart disease. By examining this critical issue, we aim to contribute meaningfully to the ongoing discussions on healthcare equity and accessibility. The findings and insights gleaned from our research have the potential to influence policymaking and interventions in the healthcare sector, ultimately enhancing outcomes for individuals across urban and rural communities.


## **INTRODUCTION**
The relationship between access to healthcare services and individual health outcomes is profound, with notable disparities emerging between urban and rural areas. To create effective interventions and policies, it is imperative to understand the factors contributing to these discrepancies and their impact on health outcomes, particularly cardiovascular diseases.  
  
This project aims to illuminate the key factors influencing healthcare access disparities, with a view to leveraging this knowledge in developing policy interventions for improving cardiovascular disease outcomes. Through rigorous data analysis and predictive modeling, we have established a correlation between the prevalence of heart disease and the urban or rural residence of individuals.  
  
The forthcoming sections detail our investigative journey, offering a transparent look into our methodology and conclusions. We will first present our exploratory analysis, illuminating interesting patterns we unearthed in the process. Subsequently, we delved into the machine learning models that helped us gain deeper insights from our data exploration. Following this, we detail how we harnessed these insights to make predictive analyses with our machine learning models. Finally, we provide recommendations and propose potential enhancements that could influence the rate of heart disease prevalence in these areas.  
  
Our investigation aims to serve as a roadmap for future efforts targeting healthcare access disparities, highlighting the vital role of data science in unraveling complex societal issues. By bridging the knowledge gap, we hope to inspire impactful changes that improve healthcare accessibility, ultimately leading to healthier lives irrespective of geographical residence.

## **METHODOLOGY**
Our research journey began with a review of datasets made available by several organizations, including the Centers for Disease Control and Prevention, County Health Rankings & Roadmaps, Behavioral Risk Factor Surveillance System (BRFSS), and the U.S. Census Bureau, among others. Initially, we endeavored to merge these diverse datasets into a singular, usable set—a complex and time-consuming task. However, this effort was superseded by our discovery of the Interactive Atlas of Heart Disease and Stroke, provided by the CDC. This comprehensive dataset offered a rich pool of information, encompassing heart disease prevalence data, other medical conditions, demographics, healthcare delivery and insurance, as well as social, economic, and environmental data. All data was presented at both the state and county level, further aiding our analysis.  
  
As we walk you through this journey, our findings will demonstrate the integral role of methodical data analysis in unearthing the complex factors contributing to disparities in healthcare access. The goal is to provide a thorough and nuanced understanding of the healthcare landscape, which could influence future interventions and policy development.

#### *Data Cleaning and Feature Engineering*
The data acquisition from the CDC Interactive Atlas of Heart Disease and Stroke proved to be a complex task, as the information wasn't available as a single dataset. Instead, we had to download more than 60 individual datasets. Managing these files and coordinating the development of the necessary code across our team was challenging. To streamline these tasks and handle version control, we utilized Git and GitHub—a decision that provided valuable experience in collaborative coding and version management.  
  
Once compiled, the data needed substantial manipulation to be tailored to our specific needs. Our preparation process involved merging the various datasets into a single, coherent dataset, eliminating superfluous features and observations, and conducting other data manipulations to improve usability.  
  
A crucial part of our data preparation was handling missing and "NA" values. In instances where missing values could be inferred from alternative data sources, we conducted further research and used coding methods to populate these data. For missing values without readily available replacements, we imputed the data using mean values based on specific criteria.  
<br>
```{r}
rmarkdown::paged_table(head(cdc_clean, n=20))

```
##### *Table 1: Sample data from fully cleaned dataset*  
<br>
Following our comprehensive data manipulation process, we had transformed the raw data into a structured and analyzable format, as in Table 1. This equipped us to dive into a detailed exploratory analysis. This painstaking process of data preparation emphasized the critical role of thorough data cleaning and feature engineering in successful data science projects. By laying a solid foundation through these initial steps, we were able to engage in robust analyses that yield dependable insights and conclusions.


### *Exploratory Data Analysis*

**Data Description:**  
Our dataset consists of 3,140 rows, each corresponding to a county in the United States, and 46 columns representing various variables. The variables span a range of categories, including:

- Geographic: county, state, urban or rural categorization, and more.

- Health-specific: prevalence of coronary heart disease (CHD), high blood pressure, and high cholesterol, stroke, diabetes, etc.

- Healthcare Infrastructure: number of doctors, cardiologists, hospitals, and hospitals with cardiac units, etc.

- Socio-economic: percentage of population in poverty, median income, median home value, and education level.

- Lifestyle and Environmental: number of parks, air quality, access to broadband, etc.

- Demographic: Age over 65, ethnicity, sex, etc.

These variables were chosen because each one is either directly linked or indirectly associated with CHD in some manner.

**Demographic Distribution:**  
With 3,140 counties to study, 1165 are categorized as Urban and 1975 as Rural. The states with the highest number of counties in our study are Texas, Georgia, and Virginia, while those with the least are D.C., Delaware, and Hawaii.  


```{r figure1, echo=FALSE}
# Reverse the color palette
color_func <- colorRampPalette(c("lightgreen", "darkgreen"))
custom_colors <- rev(color_func(10))

# Select top 10 rural states
top_rural <- cdc %>%
  filter(UrbanRural == "Rural") %>%
  group_by(state) %>%
  summarise(count = n()) %>%
  arrange(count) %>%
  slice_tail(n = 10) %>%
  mutate(state = factor(state, levels = rev(state)))

# Plot top 10 rural states
mostRural = ggplot(top_rural, aes(x = state, y = count, fill = state)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5) +
  labs(title = "Top 10 States with Most Rural",
       x = "State", y = "Count") +
  scale_fill_manual(values = custom_colors) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```


```{r figure2, echo=FALSE}
# Reverse the color palette
color_func <- colorRampPalette(c("lightblue", "darkblue"))
custom_colors <- rev(color_func(10))

# Select top 10 urban states
top_urban <- cdc %>%
  filter(grepl("Urban", UrbanRural)) %>%
  group_by(state) %>%
  summarise(count = n()) %>%
  arrange(count) %>%
  slice_tail(n = 10) %>%
  mutate(state = factor(state, levels = rev(state)))

# Plot top 10 urban states
mostUrban = ggplot(top_urban, aes(x = state, y = count, fill = state)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5) +
  labs(title = "Top 10 States with Most Urban",
       x = "State", y = "Count") +
  scale_fill_manual(values = custom_colors) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```


```{r}
# Arrange plots side by side
grid.arrange(mostUrban, mostRural, ncol = 2)
```

When focusing on the urban-rural divide, the top five states with the highest amount of urban counties are California, New York, Texas, Virginia, and Florida. On the flip side, the states with the most rural counties are Texas, Kansas, Kentucky, Georgia, and Missouri. 

**CHD Prevalence Across Urban and Rural Counties**  
CHD has an average prevalence of 8.2% across all counties, but we note a small difference between urban (7.24%) and rural counties (8.7%). 

The differences are even more striking when comparing large urban counties with rural ones. 

```{r}
library(RColorBrewer)
colors <- brewer.pal(4, "Set2")

ggplot(data = cdc, aes(x = `UrbanRural`, y = `CHD`, fill = `UrbanRural`)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = colors) +
  labs(x = "Urban or Rural Area", 
       y = "Prevalence of Coronary Heart Disease", 
       fill = "Area Type",
       title = "Prevalence of Coronary Heart Disease in Urban and Rural Areas") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5))
```


```{r}
# Top 10 states with highest prevalence
highest_prevalence <- cdc %>%
  group_by(state) %>%
  summarise(average_CHD = mean(CHD, na.rm = TRUE)) %>%
  arrange(desc(average_CHD)) %>%
  slice(1:10) %>%
  mutate(average_CHD_text = sprintf("%.1f%%", average_CHD))

# Top 10 states with lowest prevalence
lowest_prevalence <- cdc %>%
  group_by(state) %>%
  summarise(average_CHD = mean(CHD, na.rm = TRUE)) %>%
  arrange(average_CHD) %>%
  slice(1:10) %>%
  mutate(average_CHD_text = sprintf("%.1f%%", average_CHD))

# Add a new column to differentiate between the two groups
highest_prevalence$group <- "Highest Prevalence"
lowest_prevalence$group <- "Lowest Prevalence"

# Combine the two data frames
combined_prevalence <- rbind(highest_prevalence, lowest_prevalence)

# Create the plot
ggplot(combined_prevalence, aes(x = reorder(state, average_CHD), y = average_CHD)) +
  geom_bar(stat = "identity", aes(fill = group)) +
  geom_text(aes(label = average_CHD_text), hjust = 1.2, size = 3) +
  coord_flip() +
  facet_grid(group ~ ., scales = "free", space = "free") +
  scale_y_continuous(limits = c(0, 11)) +
  scale_fill_manual(values = c("darkorange", "steelblue")) +
  theme_fivethirtyeight() +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(), 
        legend.position = "none",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        plot.background = element_blank(),
        strip.text = element_text(size = 13))+
  ggtitle("Average Coronary Heart Disease Prevalence (%)")

```

Then we wanted to look at the extremes or the unexpected values to see what was interesting.  We looked at the rural counties with the lowest prevalence rates of CHD, and then looked at the urban counties with the highest rates.  There was some differences we noticed, such as in the higher CHD prevalence group also had higher blood pressure rates, higher cholesterol,  stroke, etc… None of these differences seemed to point to anything other than a difference between higher prevalence rates of CHD and lower, not what we were expecting to see of a difference between urban and rural counties. 


```{r}
# Calculate the average CHD prevalence by state and UrbanRural level
chd_prevalence_by_state_and_urbanrural <- cdc %>%
  group_by(state, UrbanRural) %>%
  summarise(average_CHD = mean(CHD, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(UrbanRural = recode(UrbanRural, 
                             "Large_Urban" = "Urban-Lg",
                             "LargeFringe_Urban" = "Urban-Lg Fringe",
                             "MediumSmall_Urban" = "Urban-Med,Sm",
                             "Rural" = "Rural"),
        state = fct_rev(state))

# Generate a heatmap
ggplot(chd_prevalence_by_state_and_urbanrural, aes(y = state, x = UrbanRural, fill = average_CHD)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red") +
  labs(y = "State", x = "Urban/Rural Level", fill = "Avg Prevalence", 
       title = "Heatmap of CHD Prevalence by State and Urban/Rural Level") +
  theme(axis.text.x = element_text(angle = 0),
        legend.title = element_text(angle = 90))

```

**Healthcare Facilities and Professionals**  
Analyze the role of healthcare availability and infrastructure in CHD prevalence:

- Urban counties have, on average, more hospitals (2.2 per county) compared to rural counties (0.9 per county), making the average per county 1.

- When adjusted for population, there are 7 hospitals per 100,000 people in rural counties compared to 1.7 in urban counties.

- One surprising finding was that 227 urban counties and 473 rural counties lack a hospital.

- There are more primary care physicians in urban counties (258 per county) compared to rural counties (38 per county). However, after adjusting for population, there are 152 PCPs per 1,000 people in urban areas and 127 in rural ones.

**Population Factors**  
Other factors that may influence CHD prevalence:  
The percentage of the population aged 65 and older is slightly higher in rural counties (20%) than in urban ones (17%).

**Correlation Analysis**  

- CHD shows high positive correlation with Stroke, High Blood Pressure (HBP), and High Cholesterol (HighChol). Which makes sense, since the diagnostic criteria for diagnosing coronary heart disease is having had a stroke, high blood pressure, and high cholesterol. Other high positive correlations include stroke and HBP, HighChol and HBP, and population with all kinds of hospitals and cardiologists, see Figure 1.  These are expected findings, since high blood pressure is a risk factor for strokes, and you would expect areas of high population density to have a higher concentration of hospitals and specialists like cardiologists. 


```{r}
# calculate the correlation matrix
correlation_matrix <- cor(cdc_clean[, c("CHD", "HighBP", "HighChol", "Stroke", "pop", "Hospitals", "pcp", "CardioPhys")])

# Increase label size
qgraph(correlation_matrix, layout = "circle", labels = names(correlation_matrix), vsize = 11, vsize2 = 0.5)

```
Figure 1: Correlation Network of Variables  
In the graphic above, the red lines represent negative correlations, green lines represent positive correlations. The thicker the line the stronger the correlation.

- Coronary heart disease shows moderate positive correlations with smoking, poverty, less than a college education, broadband availability, and % of population that is age 65+. So these were factors we were interested to look at when engineering features for our models.

```{r}
cdc %>%
    select("Smoker",
           "Poverty",
           "EdLessColl",
           "Broadband",
           "Age65Plus",
           "UrbanRural") %>%
  mutate(UrbanRural = recode(UrbanRural, 
                             "Large_Urban" = "Urban-Lg",
                             "LargeFringe_Urban" = "Urban-Med",
                             "MediumSmall_Urban" = "Urban-Sm",
                             "Rural" = "Rural")) %>% 
    ggpairs(mapping = aes(color = .$"UrbanRural", alpha = 0.5))

```

- A negative high correlation was observed between median household income and stroke.  Which meant to us that if you had a higher income your risk of stroke was lower.  We don’t know why that is, but perhaps due to having higher income you were more likely able to have health insurance, take time off from work to see a doctor, and maybe even live a healthier lifestyle. These would be things that would be interesting to investigate further, in future projects.

- Coronary heart disease shows moderate negative correlations with median household income and median home value, which we interpreted as meaning that the higher your income level, you were more likely to afford a higher valued house, and it translated to having a lower prevalence for coronary heart disease.

**Urban-Rural Divide**  
We were interested to dive deeper into the disparities between urban and rural counties:

- In terms of obesity, physical inactivity, cholesterol medication non-adherence, and percentage of uninsured, no significant urban-rural differences were observed.

- Further exploration and analysis may be needed to understand the role of these factors in CHD prevalence.

# Placeholder for graphic
(*Include a visualization here (not really seeing difference in urban rural, obesity, physical inactivity, chol med non adherence, % uninsured))

```{r}
correlation_matrix <- cor(cdc[, c("Smoker",
         "Poverty",
         "EdLessColl",
         "Broadband",
         "Age65Plus"
         )])
corrplot(correlation_matrix, method = "number")

```

```{r}
cdc %>%
    select("Obesity", "PhysInactivity", "CholMedNonAdhear", "HealthIns", "UrbanRural") %>%
  mutate(UrbanRural = recode(UrbanRural, 
                             "Large_Urban" = "Urban-Lg",
                             "LargeFringe_Urban" = "Urban-Med",
                             "MediumSmall_Urban" = "Urban-Sm",
                             "Rural" = "Rural")) %>% 
    ggpairs(mapping = aes(color = .$"UrbanRural", alpha = 0.5))

```

**Analysis of Top Predictors**  
Deep dive into the top predictors of CHD, Stroke, HBP, and HChol:  
# Placeholder for graphic  
(*include visualization density plots top 5 most influential predictors for each condition? Edlesscoll healthins poverty smoker?
*include scatter plots?)
```{r}
ggplot(cdc, aes(x = Broadband, fill = UrbanRural)) +
  geom_density(alpha = 0.5) +
  labs(x = "EdLessColl", y = "Density") +
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2")

```

Jesse notes for graphics:  
pretty density plots(line 2k ish?) colored overlay graphs
	top 5 variables, (ed, ins, poverty, smoker) look at line 2000, 
	copy, paste? medium home value, ln2106 for example

towards end, nicer scatter for three or so of them, CHD at 4011
	change code to select just the few we need as CDC2.
	
	
### *Machine Learning Models*




<br>
```{r echo=FALSE, fig.align='center', fig.cap='Figure 2: Variable Connections'}
knitr::include_graphics("images/VarConnect.png")

```
<br>

<br>
```{r echo=FALSE, fig.align='center', fig.cap='Figure 3: Variable Connections with Interactions'}
knitr::include_graphics("images/VarConnectInteract.png")

```
<br>

## **RECOMMENDATIONS**
Summarize the EDA, Models, predictions, and recommendations  
Health disparities represent a critical issue in our healthcare system, influenced by a complex interplay of socio-demographic factors.  
  
  
Discuss challenges faced
- How or if we worked around those challenges
- Discuss what we could have done better/different
- Discuss what we would have liked to do if had more time
- Discuss what could be done with this in the future  
  
  
Of course, this project is not without its limitations. Public datasets may lack granularity or may not capture all the nuances of the healthcare system. The observational nature of this analysis limits our ability to draw definitive causal conclusions. However, despite these constraints, the findings of this project can serve as a springboard for future research and can provide important directional insights. Future iterations of this project could involve integrating richer datasets, implementing more sophisticated models, and collaborating with healthcare providers or institutions to apply the insights in real-world settings. Regardless of these potential improvements, this project stands as a testament to the power of using data in promoting health equity and fostering positive societal change.  


blah blah blah.


## **CONCLUSION**
blah blah blah and done.