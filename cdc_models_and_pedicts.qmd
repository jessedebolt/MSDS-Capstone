---
title: "MSDS 2023 Capstone Project"
author: "Jesse DeBolt & Isaac Johnson"
date: "`r Sys.Date()`"
format: html
subtitle: Secondary document for models and predictions
---

#.
# Setup
#.

### Load libraries and knit setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# Load the necessary libraries
library(httr)
library(readr)
library(tidyverse)
library(gdata)
library(skimr)
library(DataExplorer)
library(GGally)
library(caret)
library(e1071)
library(randomForest)
library(rpart)
library(rpart.plot)
library(corrplot)
library(reshape2)
library(mice)
library(moderndive)
library(dplyr)

```


### Files located in the GitHub repository data folder
```{r}
# File names list
filenames <- c("SEED-UR-Urban-Rural.csv",
               "SEED-SE-Unemployment_Rate.csv",
               "SEED-SE-Poverty.csv",
               "SEED-SE-Median_Household_Income.csv",
               "SEED-SE-Median_Home_Value.csv",
               "SEED-SE-Food_Stamp_SNAP_recipients.csv",
               "SEED-SE-Education-LessThanCollege.csv",
               "SEED-SE-Broadband.csv",
               "SEED-PE-Park_Access.csv",
               "SEED-PE-Air_Quality.csv",
               "RF-Smoking.csv",
               "RF-Physical_Inactivity.csv",
               "RF-Obesity.csv",
               "RF-High_Cholesterol.csv",
               "RF-Diagnosed_Diabetes.csv",
               "Prev-Stroke.csv",
               "Prev-High_Blood_Pressure.csv",
               "Prev-Coronary_Heart_Disease.csv",
               "HCDI-PS-PCP.csv",
               "HCDI-PS-CDP.csv",
               "HCDI-Insurance-Health_Insurance_Status.csv", 
               "HCDI-HP-Pharmacies_and_Drug_Stores.csv",
               "HCDI-HP-Hospitals.csv",
               "HCDI-CRU-Participation_Among_Eligible.csv",
               "HCDI-CRU-Eligibility_Rate.csv",
               "HCDI-CLM-Nonadherence.csv",
               "HCDI-Cholesterol_Screening.csv",
               "HCDI-BPM-Medication_Use.csv",
               "Demo-Total_Population.csv",
               "Demo-Age65Plus.csv"
               )

```


### Create a function to generate the URL for a given filename
```{r}
generate_url <- function(filename) {
  return(paste0("https://raw.githubusercontent.com/jessedebolt/MSDS-Capstone/main/data_raw/", filename))
}

```


### Generate urls for each filename
```{r}
urls <- sapply(filenames, generate_url)

```


### Read the CSV files into a list of data frames
```{r }
# Read the CSV files into a list of data frames
df_list <- lapply(urls, read_csv)

# Create names for the list items (remove the .csv from the filenames)
names(df_list) <- sapply(filenames, function(filename) gsub(".csv", "", filename))

# Create individual data frames
list2env(df_list, .GlobalEnv)

```


### Merge all sets together into one data frame
```{r}
# Get all the data frame names in the global environment
df_names <- ls(.GlobalEnv)

# Initialize an empty data frame for the final result
cdc <- data.frame()

# Loop through each data frame
for (df_name in df_names) {
  
  # Get the data frame
  df <- get(df_name, envir = .GlobalEnv)
  
  # Check if 'cnty_fips' and 'display_name' exist in the data frame
  if(all(c("cnty_fips", "display_name") %in% colnames(df))){
    
    # Convert 'cnty_fips' column to character type
    df$cnty_fips <- as.character(df$cnty_fips)
    
    # Select all columns excluding those with "theme_range" in their name
    df <- df %>%
      select(-contains("theme_range"))

    # Rename each variable, except 'cnty_fips' and 'display_name', to include the data frame name
    df <- df %>%
      rename_with(.cols = -c(cnty_fips, display_name),
                  .fn = ~ paste(df_name, ., sep = "_"))
    
    # Join the data frame with the final data frame
    if (nrow(cdc) == 0){
      cdc <- df
    } 
    else {
      cdc <- full_join(cdc, df, by = c("cnty_fips", "display_name"))
      
      # Remove the ".x" from the column names
      names(cdc) <- gsub("\\.x$", "", names(cdc))
      
      # Remove the "_Value" from the column names
      names(cdc) <- gsub("\\_Value$", "", names(cdc))
    }
  }
}

```


### Renaming variables
```{r}
# Mapping of original names to new names
name_mapping <- c("cnty_fips" = "fips",
                  "display_name" = "display_name",
                  "SEED-UR-Urban-Rural" = "UrbanRural",
                  "SEED-SE-Unemployment_Rate" = "Unemploy",
                  "SEED-SE-Poverty" = "Poverty",
                  "SEED-SE-Median_Household_Income" = "MedHouseIncome",
                  "SEED-SE-Median_Home" = "MedHomeValue",
                  "SEED-SE-Food_Stamp_SNAP_recipients" = "SNAPrecipients",
                 "SEED-SE-Education-LessThanCollege" = "EdLessColl",
                 "SEED-SE-Broadband" = "Broadband",
                 "SEED-PE-Park_Access" = "Parks",
                 "SEED-PE-Air_Quality" = "AirQuality",
                 "RF-Smoking" = "Smoker",
                 "RF-Physical_Inactivity" = "PhysInactivity",
                 "RF-Obesity" = "Obesity",
                 "RF-High_Cholesterol" = "HighChol",
                 "RF-Diagnosed_Diabetes" = "Diabetes",
                 "Prev-Stroke" = "Stroke",
                 "Prev-High_Blood_Pressure" = "HighBP",
                 "Prev-Coronary_Heart_Disease" = "CHD",
                 "HCDI-PS-PCP" = "PrimaryCarePhys",
                 "HCDI-PS-CDP" = "CardioPhys",
                 "HCDI-Insurance-Health_Insurance_Status" = "HealthIns",
                 "HCDI-HP-Pharmacies_and_Drug_Stores" = "Pharmacies",
                 "HCDI-HP-Hospitals" = "Hospitals",
                 "HCDI-CRU-Participation_Among_Eligible" = "cruParticipate",
                 "HCDI-CRU-Eligibility_Rate" = "CholMedElegible",
                 "HCDI-CLM-Nonadherence" = "CholMedNonAdhear",
                 "HCDI-Cholesterol_Screening" = "CholScreen",
                 "HCDI-BPM-Medication_Use" = "bpmUse",
                 "Demo-Total_Population" = "pop",
                 "Demo-Age65Plus" = "Age65Plus"
                 )

# Get the column names of the data frame
original_names <- colnames(cdc)

# Find the corresponding new names using the mapping
new_names <- name_mapping[match(original_names, names(name_mapping))]

# Rename the variables in the data frame
colnames(cdc) <- new_names

```


### Read in data for table descriptions
```{r}
TableDesc <- read_csv("data_support/Table_Descriptions.csv")

```

#.
# Data Cleaning
#.

## General data cleaning
### Removing US territories
```{r}
#Remove territories
cdc <- cdc %>%
  filter(!grepl("\\(AS\\)|\\(GU\\)|\\(MP\\)|\\(PR\\)|\\(County Equivalent\\)", as.character(display_name)))

```


### Separated County and State
```{r}
# Separate the 'display_name' column
cdc <- cdc %>% separate(display_name, into = c("county", "state"), sep = ", \\(|\\)", remove = TRUE, convert = TRUE)

# Remove the closing parenthesis from the state column
cdc$state <- gsub("\\)", "", cdc$state)

# Remove the quotation marks from the 'county' column
cdc$county <- gsub("\"", "", cdc$county)

print(cdc)

```


### Make backup and display first few rows
```{r}
cdc_copy <- cdc

head(cdc)

```


### Relabeling Urban/Rural codes
```{r}
#change rural/urban
# 1 = Large central metro -> Large_Urban
# 2 = Large fringe metro -> LargeFringe_Urban
# 3 = Medium/small metro -> MediumSmall_Urban
# 4 = Nonmetro -> Rural

cdc$"UrbanRural" <-
    ifelse(cdc$"UrbanRural" == 1,
           "Large_Urban",
    ifelse(cdc$"UrbanRural" == 2,
           "LargeFringe_Urban",
    ifelse(cdc$"UrbanRural" == 3,
           "MediumSmall_Urban",
    ifelse(cdc$"UrbanRural" == 4,
           "Rural",
           cdc$"UrbanRural"))))

### Replacing '-1' with 'NA' under assumption that these are truly missing elements
cdc[cdc == -1] <- NA

```


### Review header names, check for missing rural/urban values
```{r}
names(cdc)

unique(cdc$'UrbanRural')

rural_query <- filter(cdc, `UrbanRural` %in% c(NA, "", "NA"))

head(rural_query, n=20)

```


### Inserting Rural/Urban for missing value
```{r}
# Find and insert where county is 'Kusilvak' based on Wikipedia data.
cdc$"UrbanRural"[grepl("Kusilvak", cdc$county)] <- "Rural"

unique(cdc$'UrbanRural')

# Double check for any NAs in Rural/Urban
rural_query <- filter(cdc, `UrbanRural` %in% c(NA, "", "NA"))
head(rural_query, n=20)

```


### Inserting Parks missing value
```{r}
# Find and insert where county is 'Kusilvak' based on average for all AK counties.
cdc$"Parks"[grepl("Kusilvak", cdc$county)] <- 66

```


### Checking for missing values
```{r}
#total number of missing values in dataset
sum(is.na(cdc))

#total number of missing values in each column
colSums(is.na(cdc))

#total number of missing values in each column
count_na_func <- function(x) sum(is.na(x)) 
cdc <- cdc %>%
  mutate(count_na = apply(., 1, count_na_func)) %>% 
  arrange(desc(count_na))

```


### Remove counties with minimal data
```{r}
# Remove those that have more than 8 NAs in that row
cdc <- cdc[cdc$count_na <= 8, ]

# Remove count_na column
cdc$count_na <- NULL

```


## Populating missing values
### Single value entry
### Inserting value for missing values in bpmUse for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"bpmUse"[grepl("NJ", cdc$state)] <- 71.71

```
Source: Average of NJ Cities from
500_Cities: Taking medicine for high blood pressure control among adults aged >=18 Years with high blood pressure
File: 500_Cities__Taking_medicine_for_high_blood_pressure_control_among_adults_aged___18_years_with_high_blood_pressure.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-Taking-medicine-for-high-blood-pressure/4peq-qp55


### Inserting value for missing values in CholScreen for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"CholScreen"[grepl("NJ", cdc$state)] <- 79.43

```
Source: Average of NJ Cities from
500 Cities: Cholesterol screening among adults aged >=18 years
FIle: 500_Cities__Cholesterol_screening_among_adults_aged___18_years.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-Cholesterol-screening-among-adults-aged/myk4-ptre


### Inserting value for missing values in HighBP for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"HighBP"[grepl("NJ", cdc$state)] <- 33.7

```
Source: Average of NJ Cities from
500 Cities: High blood pressure among adults aged >=18 years
File: 500_Cities__High_blood_pressure_among_adults_aged___18_years.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-High-blood-pressure-among-adults-aged-1/ebxs-yc6e


### Inserting value for missing values in Diabetes for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"Diabetes"[grepl("NJ", cdc$state)] <- 17.4

```
Source: Average of NJ Cities from
500 Cities: Diagnosed diabetes among adults aged >=18 years
File: 500_Cities__Diagnosed_diabetes_among_adults_aged___18_years.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-Diagnosed-diabetes-among-adults-aged-18/cn78-b9bj


### Inserting value for missing values in HighChol for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"HighChol"[grepl("NJ", cdc$state)] <- 32.41

```
Source: Average of NJ Cities from
500 Cities: High cholesterol among adults aged >=18 years who have been screened in the past 5 years
File:500_Cities__High_cholesterol_among_adults_aged___18_years_who_have_been_screened_in_the_past_5_years.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-High-cholesterol-among-adults-aged-18-y/mc6z-sjie


### Inserting value for missing values in Obesity for NJ
```{r}
# Find NAs and replace where state is 'NJ'
cdc$"Obesity"[grepl("NJ", cdc$state)] <- 33.59

```
Source: Average of NJ Cities from
500 Cities: Obesity among adults aged >=18 years
File: 500_Cities__Obesity_among_adults_aged___18_years.csv
Source: https://chronicdata.cdc.gov/500-Cities-Places/500-Cities-Obesity-among-adults-aged-18-years/bjvu-3y7d


### Inserting values for missing values in Median Home Value
```{r}
cdc$"MedHomeValue"[grepl("48261", cdc$fips)] <- 42550
cdc$"MedHomeValue"[grepl("48301", cdc$fips)] <- 38143
cdc$"MedHomeValue"[grepl("46017", cdc$fips)] <- 101393
cdc$"MedHomeValue"[grepl("46095", cdc$fips)] <- 60537

```
Reference:
Kenedy TX (fips 48261): Median Home Value = $42,550
https://www.city-data.com/county/Kenedy_County-TX.html
Loving TX (fips 48301): Median Home Value = $38,143
http://www.city-data.com/county/Loving_County-TX.html
Buffalo SD (fips 46017): Median Home Value = $101,393
http://www.city-data.com/county/Buffalo_County-SD.html
Mellette SD (fips 46095): Median Home Value = $60,537
http://www.city-data.com/county/Mellette_County-SD.html


## Multiple value entry
### Read in additional data
```{r}
pcp_cardio_count <- read_csv("data_support/pcp_cardio_count.csv")

pcp_cardio_count$COUNTY = as.character(pcp_cardio_count$COUNTY)

```


### Populating missing items for PCPs and Cardio Phys
```{r}
# Joining count data frame to the cdc data frame
cdc <- left_join(cdc, pcp_cardio_count, by = c("fips" = "COUNTY"))

# Use coalesce to replace NAs in PCP and CardioPhys
cdc <- cdc %>% 
  mutate(
    pcp = coalesce(pcp, PrimaryCarePhys),
    CardioPhys = coalesce(CardioPhys, cardio)
  )

# Remove the temporary columns
cdc <- cdc %>% select(-PrimaryCarePhys, -cardio)

```


## Imputations
### Impute remaining missing Cardiologists and Primary Care Physicians based on median of urban/rural for each state
```{r}
# Calculate medians and impute NAs
cdc <- cdc %>%
  group_by(state) %>%
  group_by(UrbanRural) %>% 
  mutate(
    CardioPhys = replace_na(CardioPhys, median(CardioPhys, na.rm = TRUE)),
    pcp = replace_na(pcp, median(pcp, na.rm = TRUE))
  )
```


### Imputing missing values in CholMedNonAdhear based on median of urban/rural for each state
```{r}
cdc = cdc %>%
  group_by(state) %>%
  group_by(UrbanRural) %>% 
  mutate(CholMedNonAdhear = replace_na(CholMedNonAdhear, median(CholMedNonAdhear, na.rm=TRUE)))

```


### Imputing missing values in CholMedElegible based on median of urban/rural for each state
```{r}
cdc = cdc %>% 
  group_by(state) %>%
  group_by(UrbanRural) %>% 
  mutate(CholMedElegible = replace_na(CholMedElegible, median(CholMedElegible, na.rm=TRUE)))

```


### Imputing missing values in cruParticipate based on median of urban/rural for each state
```{r}
cdc = cdc %>% 
  group_by(state) %>%
  group_by(UrbanRural) %>% 
  mutate(cruParticipate = replace_na(cruParticipate, median(cruParticipate, na.rm=TRUE)))

```


### Imputing missing values in PhysInactivity based on median of urban/rural for each state
```{r}
cdc = cdc %>% 
  group_by(state) %>%
  group_by(UrbanRural) %>% 
  mutate(PhysInactivity = replace_na(PhysInactivity, median(PhysInactivity, na.rm=TRUE)))

```


### Imputing missing values in AirQuality based on median of urban/rural for each state
```{r}
cdc = cdc %>% 
  group_by(state) %>%
  group_by(UrbanRural) %>% 
  mutate(AirQuality = replace_na(AirQuality, median(AirQuality, na.rm=TRUE)))

```


### Checking for missing values
```{r}
#total number of missing values in dataset
sum(is.na(cdc))

#total number of missing values in each column
colSums(is.na(cdc))

```

#.
# Feature Engineering
#.

## General feature engineering
### Convert urban/rural variables to factors
```{r}
cdc$UrbanRural <- as.factor(cdc$UrbanRural)

```


### Remove unneeded/duplicated columns
```{r}
# Select and rearrange columns
cdc <- cdc %>% select(c("county", "state", "UrbanRural", "CHD", "HighBP", "HighChol", "Stroke", "Diabetes", "Obesity",
"PhysInactivity", "Smoker", "Age65Plus","CholScreen",
"CholMedNonAdhear", "CholMedElegible", "cruParticipate",
"bpmUse", "MedHouseIncome", "Poverty", "Unemploy",
"SNAPrecipients", "EdLessColl", "MedHomeValue",
"HealthIns", "AirQuality", "Parks", "Broadband","pcp",
"CardioPhys", "Hospitals", "Pharmacies", "pop"))

```


### Clean up global environment
```{r}
keep(cdc, TableDesc, sure = TRUE)

```

#.
# Linear Models
#.

#.
# CHD as target
#.

## CHD Models
### Full model CHD as target method=lm
```{r}
# Set the seed
set.seed(2112)

#create dataset for model
cdc_CHD_full <- cdc %>% select(-c(county, state,))

cdc_CHD_full$UrbanRural <- factor(ifelse(cdc_CHD_full$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_CHD_full <- createDataPartition(cdc_CHD_full$CHD, p = 0.8, list = FALSE)
cdc_tr_CHD_full <- cdc_CHD_full[cdc_index_CHD_full, ]
cdc_te_CHD_full <- cdc_CHD_full[-cdc_index_CHD_full, ]

#Rsquared 95%
control_CHD_full <- trainControl(method="repeatedcv", number =5, repeats=3)
model_CHD_full <- train(CHD ~ ., data=cdc_tr_CHD_full, method="lm", trControl = control_CHD_full)
print(model_CHD_full$resample)
model_CHD_full

importance_CHD_full <- varImp(model_CHD_full, scale=TRUE)
importance_CHD_full
plot(importance_CHD_full)

```


### Full model CHD as target method=glm
```{r}
# Set the seed
set.seed(2112)

#create dataset for model
cdc_CHD_full <- cdc %>% select(-c(county, state,))

cdc_CHD_full$UrbanRural <- factor(ifelse(cdc_CHD_full$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_CHD_full <- createDataPartition(cdc_CHD_full$CHD, p = 0.8, list = FALSE)
cdc_tr_CHD_full <- cdc_CHD_full[cdc_index_CHD_full, ]
cdc_te_CHD_full <- cdc_CHD_full[-cdc_index_CHD_full, ]

#Rsquared 95%
control_CHD_full <- trainControl(method="repeatedcv", number =5, repeats=3)
model_CHD_full <- train(CHD ~ ., data=cdc_tr_CHD_full, method="glm", trControl = control_CHD_full)
print(model_CHD_full$resample)
model_CHD_full

importance_CHD_full <- varImp(model_CHD_full, scale=TRUE)
importance_CHD_full
plot(importance_CHD_full)
```


### Full model CHD as target method=glm, family=poisson
```{r}
# Set the seed
set.seed(2112)

#create dataset for model
cdc_CHD_full <- cdc %>% select(-c(county, state,))

cdc_CHD_full$UrbanRural <- factor(ifelse(cdc_CHD_full$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_CHD_full <- createDataPartition(cdc_CHD_full$CHD, p = 0.8, list = FALSE)
cdc_tr_CHD_full <- cdc_CHD_full[cdc_index_CHD_full, ]
cdc_te_CHD_full <- cdc_CHD_full[-cdc_index_CHD_full, ]

#Rsquared 95%
control_CHD_full <- trainControl(method="repeatedcv", number =5, repeats=3)
model_CHD_full <- train(CHD ~ ., data=cdc_tr_CHD_full, method="glm", trControl = control_CHD_full, family="poisson")
print(model_CHD_full$resample)
model_CHD_full

importance_CHD_full <- varImp(model_CHD_full, scale=TRUE)
importance_CHD_full
plot(importance_CHD_full)

```


#### View coefficients full CHD
```{r}
coef(model_CHD_full$finalModel)

```

still shows urbanrural?! I've deselected it twice!
### Basic Model 1 just "CHD", "HighBP", "HighChol", "Stroke" 90% R2
```{r}
set.seed(2112)

#create dataset for model
cdc_basic <- cdc %>% select(CHD, HighBP, HighChol, Stroke, -UrbanRural)
cdc_basic <- cdc_basic %>% select(-UrbanRural)

#cdc_basic$UrbanRural <- factor(ifelse(cdc_basic$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic <- createDataPartition(cdc_basic$CHD, p = 0.8, list = FALSE)
cdc_tr_basic <- cdc_basic[cdc_index_basic, ]
cdc_te_basic <- cdc_basic[-cdc_index_basic, ]


control_basic <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic <- train(CHD ~ .,
                    data=cdc_tr_basic,
                    method="lm",
                    trControl = control_basic)
print(model_basic$resample)

model_basic

importance_basic <- varImp(model_basic, scale=TRUE)
importance_basic
plot(importance_basic)

```


### Basic Model 1 (glm) just "CHD", "HighBP", "HighChol", "Stroke" 90% R2
```{r}
set.seed(2112)

#create dataset for model
cdc_basic <- cdc %>% select(CHD, HighBP, HighChol, Stroke)

#cdc_basic$UrbanRural <- factor(ifelse(cdc_basic$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic <- createDataPartition(cdc_basic$CHD, p = 0.8, list = FALSE)
cdc_tr_basic <- cdc_basic[cdc_index_basic, ]
cdc_te_basic <- cdc_basic[-cdc_index_basic, ]


control_basic <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic <- train(CHD ~ .,
                    data=cdc_tr_basic,
                    method="glm",
                    trControl = control_basic)
print(model_basic$resample)

model_basic

importance_basic <- varImp(model_basic, scale=TRUE)
importance_basic
plot(importance_basic)

```


### Basic Model 1 (glm-poisson) just "CHD", "HighBP", "HighChol", "Stroke" 88% R2
```{r}
set.seed(2112)

#create dataset for model
cdc_basic <- cdc %>% select(CHD, HighBP, HighChol, Stroke)

#cdc_basic$UrbanRural <- factor(ifelse(cdc_basic$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic <- createDataPartition(cdc_basic$CHD, p = 0.8, list = FALSE)
cdc_tr_basic <- cdc_basic[cdc_index_basic, ]
cdc_te_basic <- cdc_basic[-cdc_index_basic, ]


control_basic <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic <- train(CHD ~ .,
                    data=cdc_tr_basic,
                    method="glm",
                    family = "poisson",
                    trControl = control_basic)
print(model_basic$resample)

model_basic

importance_basic <- varImp(model_basic, scale=TRUE)
importance_basic
plot(importance_basic)

```


### Basic Model 2 now added "Smoker", "Age65Plus" 94% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic <- cdc %>% select("CHD", "HighBP", "HighChol", "Stroke", "Smoker", "Age65Plus")

# cdc_basic$UrbanRural <- factor(ifelse(cdc_basic$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic <- createDataPartition(cdc_basic$CHD, p = 0.8, list = FALSE)
cdc_tr_basic <- cdc_basic[cdc_index_basic, ]
cdc_te_basic <- cdc_basic[-cdc_index_basic, ]


control_basic <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic <- train(CHD ~ .,
                    data=cdc_tr_basic,
                    method="lm",
                    trControl = control_basic)
print(model_basic$resample)

model_basic

importance_basic <- varImp(model_basic, scale=TRUE)
importance_basic
plot(importance_basic)

```


#### View coefficients basic model 2
```{r}
coef(model_basic$finalModel)

```


### Basic Model 3 now added "CholMedElegible", "HealthIns" 94.9% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic <- cdc %>% select("CHD", "HighBP", "HighChol", "Stroke", "Smoker", "Age65Plus", "CholMedElegible", "HealthIns")

# cdc_basic$UrbanRural <- factor(ifelse(cdc_basic$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic <- createDataPartition(cdc_basic$CHD, p = 0.8, list = FALSE)
cdc_tr_basic <- cdc_basic[cdc_index_basic, ]
cdc_te_basic <- cdc_basic[-cdc_index_basic, ]


control_basic <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic <- train(CHD ~ .,
                    data=cdc_tr_basic,
                    method="lm",
                    trControl = control_basic)
print(model_basic$resample)

model_basic

importance_basic <- varImp(model_basic, scale=TRUE)
importance_basic
plot(importance_basic)

```


#### View coefficients basic model 3
```{r}
coef(model_basic$finalModel)

```


### Basic Model 4 now removed  "HighBP", "HighChol", "Stroke" 90.1% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic <- cdc %>% select("CHD", "Age65Plus", "Smoker", "HealthIns", "Parks", "Obesity", "MedHouseIncome", "Diabetes", "CholScreen", "UrbanRural", "SNAPrecipients", "Broadband", "AirQuality", "Pharmacies", "EdLessColl", "PhysInactivity", "Hospitals", "Poverty", "pcp", )

cdc_basic$UrbanRural <- factor(ifelse(cdc_basic$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic <- createDataPartition(cdc_basic$CHD, p = 0.8, list = FALSE)
cdc_tr_basic <- cdc_basic[cdc_index_basic, ]
cdc_te_basic <- cdc_basic[-cdc_index_basic, ]


control_basic <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic <- train(CHD ~ .,
                    data=cdc_tr_basic,
                    method="lm",
                    trControl = control_basic)
print(model_basic$resample)

model_basic

importance_basic <- varImp(model_basic, scale=TRUE)
importance_basic
plot(importance_basic)

```


#### View coefficients basic model 4
```{r}
coef(model_basic$finalModel)

```


## CHD Models with interactions
### Full model CHD as target with Urban/Rural and state interaction
```{r}
# Set the seed
set.seed(2112)

#create dataset for model
cdc_CHD_X_full <- cdc %>% select(CHD, state, UrbanRural)

cdc_CHD_X_full$UrbanRural <- factor(ifelse(cdc_CHD_X_full$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_CHD_X_full <- createDataPartition(cdc_CHD_X_full$CHD, p = 0.8, list = FALSE)
cdc_tr_CHD_X_full <- cdc_CHD_X_full[cdc_index_CHD_X_full, ]
cdc_te_CHD_X_full <- cdc_CHD_X_full[-cdc_index_CHD_X_full, ]

#Rsquared 95%
control_CHD_X_full <- trainControl(method="repeatedcv", number =5, repeats=3)
model_CHD_X_full <- train(CHD ~ UrbanRural*state, data=cdc_tr_CHD_X_full, method="lm", trControl = control_CHD_X_full)
print(model_CHD_X_full$resample)
model_CHD_X_full

importance_CHD_X_full <- varImp(model_CHD_X_full, scale=TRUE)
importance_CHD_X_full
plot(importance_CHD_X_full)

```


## CHD Models with interactions
### Full model CHD as target with Urban/Rural interactions
```{r}
# Set the seed
set.seed(2112)

#create dataset for model
cdc_CHD_X_full <- cdc

cdc_CHD_X_full$UrbanRural <- factor(ifelse(cdc_CHD_X_full$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_CHD_X_full <- createDataPartition(cdc_CHD_X_full$CHD, p = 0.8, list = FALSE)
cdc_tr_CHD_X_full <- cdc_CHD_X_full[cdc_index_CHD_X_full, ]
cdc_te_CHD_X_full <- cdc_CHD_X_full[-cdc_index_CHD_X_full, ]

#Rsquared 95%
control_CHD_X_full <- trainControl(method="repeatedcv", number =5, repeats=3)
model_CHD_X_full <- train(CHD ~ UrbanRural*Smoker + UrbanRural*PhysInactivity + UrbanRural*Broadband + UrbanRural*Hospitals + UrbanRural*Age65Plus, data=cdc_tr_CHD_X_full, method="lm", trControl = control_CHD_X_full)
print(model_CHD_X_full$resample)
model_CHD_X_full

importance_CHD_X_full <- varImp(model_CHD_X_full, scale=TRUE)
importance_CHD_X_full
plot(importance_CHD_X_full)

summary(model_CHD_X_full)
```




#.
# HighBP as target
#.

## HighBP Models
### Full Model 5 now predicting High BP  87% R2 (no urban/rural)
need whole model first for HIGH BP then stepwise feature selection
```{r}
set.seed(123)

#create dataset for model
cdc_basic_bp <- cdc %>% select("CHD", "HighBP", "HighChol", "Stroke", "Diabetes", "Obesity", "PhysInactivity", "Smoker", "Age65Plus", "CholScreen", "CholMedNonAdhear", "CholMedElegible", "cruParticipate", "bpmUse", "MedHouseIncome", "Poverty", "Unemploy", "SNAPrecipients", "EdLessColl", "MedHomeValue", "HealthIns", "AirQuality", "Parks", "Broadband", "pcp", "CardioPhys", "Hospitals", "Pharmacies", "pop") %>% select(-c("CHD", "HighChol", "Stroke"))

#cdc_basic_bp$UrbanRural <- factor(ifelse(cdc_basic_bp$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic_bp <- createDataPartition(cdc_basic_bp$HighBP, p = 0.8, list = FALSE)
cdc_tr_basic_bp <- cdc_basic_bp[cdc_index_basic_bp, ]
cdc_te_basic_bp <- cdc_basic_bp[-cdc_index_basic_bp, ]


control_basic_bp <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared 87%
model_basic_bp <- train(HighBP ~ .,
                    data=cdc_tr_basic_bp,
                    method="lm",
                    trControl = control_basic_bp)
print(model_basic_bp$resample)

model_basic_bp

importance_basic_bp <- varImp(model_basic_bp, scale=TRUE)
importance_basic_bp
plot(importance_basic_bp)
coef(model_basic_bp$finalModel)
```


### Full Model 6 predicting High BP  87% R2 URBAN OR RURAL ONLY
```{r}
set.seed(123)

#create dataset for model 
cdc_basic_bp <- cdc %>% select("CHD", "HighBP", "HighChol", "Stroke", "Diabetes", "Obesity", "PhysInactivity", "Smoker", "Age65Plus", "CholScreen", "CholMedNonAdhear", "CholMedElegible", "cruParticipate", "bpmUse", "MedHouseIncome", "Poverty", "Unemploy", "SNAPrecipients", "EdLessColl", "MedHomeValue", "HealthIns", "AirQuality", "Parks", "Broadband", "pcp", "CardioPhys", "Hospitals", "Pharmacies", "pop", "UrbanRural") %>% select(-c("CHD", "HighChol", "Stroke"))

cdc_basic_bp$UrbanRural <- factor(ifelse(cdc_basic_bp$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic_bp <- createDataPartition(cdc_basic_bp$HighBP, p = 0.8, list = FALSE)
cdc_tr_basic_bp <- cdc_basic_bp[cdc_index_basic_bp, ]
cdc_te_basic_bp <- cdc_basic_bp[-cdc_index_basic_bp, ]


control_basic_bp <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared 87%
model_basic_bp <- train(HighBP ~ .,
                    data=cdc_tr_basic_bp,
                    method="lm",
                    trControl = control_basic_bp)
print(model_basic_bp$resample)

model_basic_bp

importance_basic_bp <- varImp(model_basic_bp, scale=TRUE)
importance_basic_bp
plot(importance_basic_bp)
coef(model_basic_bp$finalModel)
```

### Full Model 6.5 predicting High BP  87% R2 all variables except state county chd stroke high chol        
```{r}
set.seed(123)

#create dataset for model 
cdc_full_bp <- cdc %>% select(-c("CHD", "HighChol", "Stroke", "state", "county"))

cdc_full_bp$UrbanRural <- factor(ifelse(cdc_full_bp$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_full_bp <- createDataPartition(cdc_full_bp$HighBP, p = 0.8, list = FALSE)
cdc_tr_full_bp <- cdc_full_bp[cdc_index_full_bp, ]
cdc_te_full_bp <- cdc_full_bp[-cdc_index_full_bp, ]


control_full_bp <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared 87%
model_full_bp <- train(HighBP ~ .,
                    data=cdc_tr_full_bp,
                    method="lm",
                    trControl = control_full_bp)
print(model_full_bp$resample)

model_full_bp

importance_full_bp <- varImp(model_full_bp, scale=TRUE)
importance_full_bp
plot(importance_full_bp)
coef(model_full_bp$finalModel)
```


### Basic Model 7 predicting High BP  63.9% R2 Diabetes CholScreen bpmUse (** bpmUse proxy for HighBP?)
```{r}
set.seed(123)

#create dataset for model
cdc_basic_bp <- cdc %>% select("HighBP", "Diabetes", "CholScreen", "bpmUse")

#cdc_basic_bp$UrbanRural <- factor(ifelse(cdc_basic_bp$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic_bp <- createDataPartition(cdc_basic_bp$HighBP, p = 0.8, list = FALSE)
cdc_tr_basic_bp <- cdc_basic_bp[cdc_index_basic_bp, ]
cdc_te_basic_bp <- cdc_basic_bp[-cdc_index_basic_bp, ]


control_basic_bp <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared 63.9%
model_basic_bp <- train(HighBP ~ .,
                    data=cdc_tr_basic_bp,
                    method="lm",
                    trControl = control_basic_bp)
print(model_basic_bp$resample)

model_basic_bp

importance_basic_bp <- varImp(model_basic_bp, scale=TRUE)
importance_basic_bp
plot(importance_basic_bp)
coef(model_basic_bp$finalModel)

```

###Basic Model 8 predicting High BP  82% R2 Added CholMedNonAdhear Smoker
```{r}
set.seed(123)

#create dataset for model
cdc_basic_bp <- cdc %>% select("HighBP", "Diabetes", "CholScreen", "bpmUse", "CholMedNonAdhear", "Smoker")

#cdc_basic_bp$UrbanRural <- factor(ifelse(cdc_basic_bp$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic_bp <- createDataPartition(cdc_basic_bp$HighBP, p = 0.8, list = FALSE)
cdc_tr_basic_bp <- cdc_basic_bp[cdc_index_basic_bp, ]
cdc_te_basic_bp <- cdc_basic_bp[-cdc_index_basic_bp, ]


control_basic_bp <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared 63.9%
model_basic_bp <- train(HighBP ~ .,
                    data=cdc_tr_basic_bp,
                    method="lm",
                    trControl = control_basic_bp)
print(model_basic_bp$resample)

model_basic_bp

importance_basic_bp <- varImp(model_basic_bp, scale=TRUE)
importance_basic_bp
plot(importance_basic_bp)
coef(model_basic_bp$finalModel)
```
(diabetes only adds 1%)
###Basic Model 9 predicting High BP  85.5% R2 Added Poverty EdLessColl removed smoker
```{r}
set.seed(123)

#create dataset for model
cdc_basic_bp <- cdc %>% select("HighBP", "Diabetes", "CholScreen", "bpmUse", "CholMedNonAdhear", "Poverty", "EdLessColl")

#cdc_basic_bp$UrbanRural <- factor(ifelse(cdc_basic_bp$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic_bp <- createDataPartition(cdc_basic_bp$HighBP, p = 0.8, list = FALSE)
cdc_tr_basic_bp <- cdc_basic_bp[cdc_index_basic_bp, ]
cdc_te_basic_bp <- cdc_basic_bp[-cdc_index_basic_bp, ]


control_basic_bp <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared 63.9%
model_basic_bp <- train(HighBP ~ .,
                    data=cdc_tr_basic_bp,
                    method="lm",
                    trControl = control_basic_bp)
print(model_basic_bp$resample)

model_basic_bp

importance_basic_bp <- varImp(model_basic_bp, scale=TRUE)
control_basic_bp
plot(importance_basic_bp)
coef(model_basic_bp$finalModel)
```

## Comparing Coefficients
```{r}
# Extracting coefficients from model_CHD_full
coef_model_CHD_full <- coef(model_CHD_full$finalModel)
diabetes_coef_model_CHD_full <- coef_model_CHD_full["Diabetes"]

# Suppose you have another model, model2
# model2 <- train(YourFormula, data=YourData, method="glm", trControl = YourControl, family="poisson")
coef_model_full_bp <- coef(model_full_bp$finalModel)
diabetes_coef_model_full_bp <- coef_model_full_bp["Diabetes"]

# Compare the coefficients
print(paste0("Diabetes coefficient in model_CHD_full: ", diabetes_coef_model_CHD_full))
print(paste0("Diabetes coefficient in model_full_bp: ", diabetes_coef_model_full_bp))

# For a direct comparison
difference <- diabetes_coef_model_CHD_full - diabetes_coef_model_full_bp
print(paste0("Difference between coefficients: ", difference))

```


## Comparing Coefficients from multiple models, (have to be same size) doesn't work yet
```{r}
# # Extract coefficients from multiple models
# coef_model1 <- coef(model_CHD_full$finalModel)
# coef_model2 <- coef(model_basic$finalModel)
# 
# # Add more if you have more models...
# 
# # Create a data frame of coefficients
# coef_df <- data.frame(
#   model1 = coef_model1,
#   model2 = coef_model2
#   # Add more if you have more models...
# )
# 
# # Print the data frame
# print(coef_df)

```
### Still playing with comparing coefficients
```{r}
# Extract coefficients from multiple models
coef_model1 <- coef(model_CHD_full$finalModel)
coef_model2 <- coef(model_basic$finalModel)

CHD_fullCF <- sort(abs(coef_model1), decreasing = TRUE)
CHD_fullBP <- sort(abs(coef_model2), decreasing = TRUE)

CHD_fullCF
CHD_fullBP
```

## Predictions
```{r}
# Make predictions on the test set
predictions <- predict(model_CHD_full, newdata = cdc_te_CHD_full)

# Print the predictions
print(predictions)

```

```{r}
# Compute the residuals
residuals <- predictions - cdc_te_CHD_full$CHD

# Compute the RMSE
rmse <- sqrt(mean(residuals^2))
print(rmse)

```

### Other measurements for GLM Poisson
```{r}
#Mean Absolute Error (MAE)
# Calculate residuals
residuals <- predictions - cdc_te_CHD_full$CHD

# Calculate MAE
mae <- mean(abs(residuals))
print(mae)

#Log-Likelihood, AIC, and BIC:
# Extract log-Likelihood
logLik_value <- logLik(model_CHD_full$finalModel)
print(logLik_value)

# Calculate AIC and BIC
aic_value <- AIC(model_CHD_full$finalModel)
bic_value <- BIC(model_CHD_full$finalModel)

print(aic_value)
print(bic_value)

#Residual plots and QQ plots:
# Generate residual plot
plot(predictions, residuals, 
     xlab="Predicted Values", ylab="Residuals", 
     main="Residual Plot")
abline(h=0, lty=2) # Add a horizontal line at y = 0

# Generate QQ plot
qqnorm(residuals)
qqline(residuals) # Add a line to help assess the normality

   
```


























































#.
# HiChol as target
#.

## HiChol Models
### Full model HighChol as target
```{r}
# Set the seed
set.seed(2112)

#create dataset for model
cdc__full_HighChol <- cdc %>% select(-c(county, state,))

cdc__full_HighChol$UrbanRural <- factor(ifelse(cdc__full_HighChol$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index__full_HighChol <- createDataPartition(cdc__full_HighChol$HighChol, p = 0.8, list = FALSE)
cdc_tr__full_HighChol <- cdc__full_HighChol[cdc_index__full_HighChol, ]
cdc_te__full_HighChol <- cdc__full_HighChol[-cdc_index__full_HighChol, ]

#Rsquared 95%
control__full_HighChol <- trainControl(method="repeatedcv", number =5, repeats=3)
model__full_HighChol <- train(HighChol ~ ., data=cdc_tr__full_HighChol, method="lm", trControl = control__full_HighChol)
print(model__full_HighChol$resample)
model__full_HighChol

importance__full_HighChol <- varImp(model__full_HighChol, scale=TRUE)
plot(importance__full_HighChol)

```


#### View coefficients full HghChol
```{r}
coef(model__full_HighChol$finalModel)

```


### Basic Model 1(HighChol) just "CHD", "HighBP", "HighChol", "Stroke" 90% R2
```{r}
set.seed(2112)

#create dataset for model
cdc_basic1_HighChol <- cdc %>% select(HighChol, HighBP, CHD, Stroke)

cdc_basic1_HighChol$UrbanRural <- factor(ifelse(cdc_basic1_HighChol$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic1_HighChol <- createDataPartition(cdc_basic1_HighChol$HighChol, p = 0.8, list = FALSE)
cdc_tr_basic1_HighChol <- cdc_basic1_HighChol[cdc_index_basic1_HighChol, ]
cdc_te_basic1_HighChol <- cdc_basic1_HighChol[-cdc_index_basic1_HighChol, ]


control_basic1_HighChol <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic1_HighChol <- train(HighChol ~ .,
                    data=cdc_tr_basic1_HighChol,
                    method="lm",
                    trControl = control_basic1_HighChol)
print(model_basic1_HighChol$resample)

model_basic1_HighChol

importance_basic1_HighChol <- varImp(model_basic1_HighChol, scale=TRUE)
plot(importance_basic1_HighChol)

```


#### View coefficients basic model 1
```{r}
coef(model_basic1_HighChol$finalModel)

```


### Basic Model 2(HighChol) now added "Smoker", "Age65Plus" 94% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic2_HighChol <- cdc %>% select("CHD", "HighBP", "HighChol", "Stroke", "Smoker", "Age65Plus")

# cdc_basic2_HighChol$UrbanRural <- factor(ifelse(cdc_basic2_HighChol$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic2_HighChol <- createDataPartition(cdc_basic2_HighChol$HighChol, p = 0.8, list = FALSE)
cdc_tr_basic2_HighChol <- cdc_basic2_HighChol[cdc_index_basic2_HighChol, ]
cdc_te_basic2_HighChol <- cdc_basic2_HighChol[-cdc_index_basic2_HighChol, ]


control_basic2_HighChol <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic2_HighChol <- train(HighChol ~ .,
                    data=cdc_tr_basic2_HighChol,
                    method="lm",
                    trControl = control_basic2_HighChol)
print(model_basic2_HighChol$resample)

model_basic2_HighChol

importance_basic2_HighChol <- varImp(model_basic2_HighChol, scale=TRUE)
plot(importance_basic2_HighChol)

```


#### View coefficients basic model 2
```{r}
coef(model_basic2_HighChol$finalModel)

```


### Basic Model 3(HighChol) now added "CholMedElegible", "HealthIns" 94.9% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic3_HighChol <- cdc %>% select("CHD", "HighBP", "HighChol", "Stroke", "Smoker", "Age65Plus", "CholMedElegible", "HealthIns")

# cdc_basic3_HighChol$UrbanRural <- factor(ifelse(cdc_basic3_HighChol$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic3_HighChol <- createDataPartition(cdc_basic3_HighChol$HighChol, p = 0.8, list = FALSE)
cdc_tr_basic3_HighChol <- cdc_basic3_HighChol[cdc_index_basic3_HighChol, ]
cdc_te_basic3_HighChol <- cdc_basic3_HighChol[-cdc_index_basic3_HighChol, ]


control_basic3_HighChol <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic3_HighChol <- train(HighChol ~ .,
                    data=cdc_tr_basic3_HighChol,
                    method="lm",
                    trControl = control_basic3_HighChol)
print(model_basic3_HighChol$resample)

model_basic3_HighChol

importance_basic3_HighChol <- varImp(model_basic3_HighChol, scale=TRUE)
plot(importance_basic3_HighChol)

```


#### View coefficients basic model 3
```{r}
coef(model_basic3_HighChol$finalModel)

```


### Basic Model 4(HighChol) now removed  "HighBP", "CHD", "Stroke" 90.1% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic4_HighChol <- cdc %>% select("HighChol", "Age65Plus", "Smoker", "HealthIns", "Parks", "Obesity", "MedHouseIncome", "Diabetes", "CholScreen", "UrbanRural", "SNAPrecipients", "Broadband", "AirQuality", "Pharmacies", "EdLessColl", "PhysInactivity", "Hospitals", "Poverty", "pcp", )

cdc_basic4_HighChol$UrbanRural <- factor(ifelse(cdc_basic4_HighChol$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic4_HighChol <- createDataPartition(cdc_basic4_HighChol$HighChol, p = 0.8, list = FALSE)
cdc_tr_basic4_HighChol <- cdc_basic4_HighChol[cdc_index_basic4_HighChol, ]
cdc_te_basic4_HighChol <- cdc_basic4_HighChol[-cdc_index_basic4_HighChol, ]


control_basic4_HighChol <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic4_HighChol <- train(HighChol ~ .,
                    data=cdc_tr_basic4_HighChol,
                    method="lm",
                    trControl = control_basic4_HighChol)
print(model_basic4_HighChol$resample)

model_basic4_HighChol

importance_basic4_HighChol <- varImp(model_basic4_HighChol, scale=TRUE)
plot(importance_basic4_HighChol)

```


#### View coefficients basic model 4
```{r}
coef(model_basic4_HighChol$finalModel)

```


#.
# Stroke as target
#.

## Stroke Models
### Full model Stroke as target
```{r}
# Set the seed
set.seed(2112)

#create dataset for model
cdc__full_Stroke <- cdc %>% select(-c(county, state,))

cdc__full_Stroke$UrbanRural <- factor(ifelse(cdc__full_Stroke$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index__full_Stroke <- createDataPartition(cdc__full_Stroke$Stroke, p = 0.8, list = FALSE)
cdc_tr__full_Stroke <- cdc__full_Stroke[cdc_index__full_Stroke, ]
cdc_te__full_Stroke <- cdc__full_Stroke[-cdc_index__full_Stroke, ]

#Rsquared 95%
control__full_Stroke <- trainControl(method="repeatedcv", number =5, repeats=3)
model__full_Stroke <- train(Stroke ~ ., data=cdc_tr__full_Stroke, method="lm", trControl = control__full_Stroke)
print(model__full_Stroke$resample)
model__full_Stroke

importance__full_Stroke <- varImp(model__full_Stroke, scale=TRUE)
plot(importance__full_Stroke)

```


#### View coefficients full Stroke
```{r}
coef(model__full_Stroke$finalModel)

```


### Basic Model 1(Stroke) just "CHD", "HighBP", "HighChol", "Stroke" 90% R2
```{r}
set.seed(2112)

#create dataset for model
cdc_basic1_Stroke <- cdc %>% select(CHD, HighBP, HighChol, Stroke)

cdc_basic1_Stroke$UrbanRural <- factor(ifelse(cdc_basic1_Stroke$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic1_Stroke <- createDataPartition(cdc_basic1_Stroke$Stroke, p = 0.8, list = FALSE)
cdc_tr_basic1_Stroke <- cdc_basic1_Stroke[cdc_index_basic1_Stroke, ]
cdc_te_basic1_Stroke <- cdc_basic1_Stroke[-cdc_index_basic1_Stroke, ]


control_basic1_Stroke <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic1_Stroke <- train(Stroke ~ .,
                    data=cdc_tr_basic1_Stroke,
                    method="lm",
                    trControl = control_basic1_Stroke)
print(model_basic1_Stroke$resample)

model_basic1_Stroke

importance_basic1_Stroke <- varImp(model_basic1_Stroke, scale=TRUE)
plot(importance_basic1_Stroke)

```


#### View coefficients basic model 1
```{r}
coef(model_basic1_Stroke$finalModel)

```


### Basic Model 2(Stroke) now added "Smoker", "Age65Plus" 94% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic2_Stroke <- cdc %>% select("CHD", "HighBP", "HighChol", "Stroke", "Smoker", "Age65Plus")

# cdc_basic2_Stroke$UrbanRural <- factor(ifelse(cdc_basic2_Stroke$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic2_Stroke <- createDataPartition(cdc_basic2_Stroke$Stroke, p = 0.8, list = FALSE)
cdc_tr_basic2_Stroke <- cdc_basic2_Stroke[cdc_index_basic2_Stroke, ]
cdc_te_basic2_Stroke <- cdc_basic2_Stroke[-cdc_index_basic2_Stroke, ]


control_basic2_Stroke <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic2_Stroke <- train(Stroke ~ .,
                    data=cdc_tr_basic2_Stroke,
                    method="lm",
                    trControl = control_basic2_Stroke)
print(model_basic2_Stroke$resample)

model_basic2_Stroke

importance_basic2_Stroke <- varImp(model_basic2_Stroke, scale=TRUE)
plot(importance_basic2_Stroke)

```


#### View coefficients basic model 2
```{r}
coef(model_basic2_Stroke$finalModel)

```


### Basic Model 3(Stroke) now added "CholMedElegible", "HealthIns" 94.9% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic3_Stroke <- cdc %>% select("CHD", "HighBP", "HighChol", "Stroke", "Smoker", "Age65Plus", "CholMedElegible", "HealthIns")

# cdc_basic3_Stroke$UrbanRural <- factor(ifelse(cdc_basic3_Stroke$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic3_Stroke <- createDataPartition(cdc_basic3_Stroke$Stroke, p = 0.8, list = FALSE)
cdc_tr_basic3_Stroke <- cdc_basic3_Stroke[cdc_index_basic3_Stroke, ]
cdc_te_basic3_Stroke <- cdc_basic3_Stroke[-cdc_index_basic3_Stroke, ]


control_basic3_Stroke <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic3_Stroke <- train(Stroke ~ .,
                    data=cdc_tr_basic3_Stroke,
                    method="lm",
                    trControl = control_basic3_Stroke)
print(model_basic3_Stroke$resample)

model_basic3_Stroke

importance_basic3_Stroke <- varImp(model_basic3_Stroke, scale=TRUE)
plot(importance_basic3_Stroke)

```


#### View coefficients basic model 3
```{r}
coef(model_basic3_Stroke$finalModel)

```


### Basic Model 4(Stroke) now removed  "HighBP", "HighChol", "Stroke" 90.1% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic4_Stroke <- cdc %>% select("Stroke", "Age65Plus", "Smoker", "HealthIns", "Parks", "Obesity", "MedHouseIncome", "Diabetes", "CholScreen", "UrbanRural", "SNAPrecipients", "Broadband", "AirQuality", "Pharmacies", "EdLessColl", "PhysInactivity", "Hospitals", "Poverty", "pcp", )

cdc_basic4_Stroke$UrbanRural <- factor(ifelse(cdc_basic4_Stroke$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic4_Stroke <- createDataPartition(cdc_basic4_Stroke$Stroke, p = 0.8, list = FALSE)
cdc_tr_basic4_Stroke <- cdc_basic4_Stroke[cdc_index_basic4_Stroke, ]
cdc_te_basic4_Stroke <- cdc_basic4_Stroke[-cdc_index_basic4_Stroke, ]


control_basic4_Stroke <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic4_Stroke <- train(Stroke ~ .,
                    data=cdc_tr_basic4_Stroke,
                    method="lm",
                    trControl = control_basic4_Stroke)
print(model_basic4_Stroke$resample)

model_basic4_Stroke

importance_basic4_Stroke <- varImp(model_basic4_Stroke, scale=TRUE)
plot(importance_basic4_Stroke)

```


#### View coefficients basic model 4
```{r}
coef(model_basic4_Stroke$finalModel)

```

#.
# Diabetes as target
#.

## Diabetes Models
### Full model Diabetes as target
```{r}
# Set the seed
set.seed(2112)

#create dataset for model
cdc__full_Diabetes <- cdc %>% select(-c(county, state,))

cdc__full_Diabetes$UrbanRural <- factor(ifelse(cdc__full_Diabetes$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index__full_Diabetes <- createDataPartition(cdc__full_Diabetes$Diabetes, p = 0.8, list = FALSE)
cdc_tr__full_Diabetes <- cdc__full_Diabetes[cdc_index__full_Diabetes, ]
cdc_te__full_Diabetes <- cdc__full_Diabetes[-cdc_index__full_Diabetes, ]

#Rsquared 95%
control__full_Diabetes <- trainControl(method="repeatedcv", number =5, repeats=3)
model__full_Diabetes <- train(Diabetes ~ ., data=cdc_tr__full_Diabetes, method="lm", trControl = control__full_Diabetes)
print(model__full_Diabetes$resample)
model__full_Diabetes

importance__full_Diabetes <- varImp(model__full_Diabetes, scale=TRUE)
plot(importance__full_Diabetes)

```


#### View coefficients full Stroke
```{r}
coef(model__full_Diabetes$finalModel)

```


### Basic Model 1(Diabetes) just "CHD", "HighBP", "HighChol", "Stroke" 90% R2
```{r}
set.seed(2112)

#create dataset for model
cdc_basic1_Diabetes <- cdc %>% select(CHD, HighBP, HighChol, Stroke, Diabetes)

cdc_basic1_Diabetes$UrbanRural <- factor(ifelse(cdc_basic1_Diabetes$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic1_Diabetes <- createDataPartition(cdc_basic1_Diabetes$Diabetes, p = 0.8, list = FALSE)
cdc_tr_basic1_Diabetes <- cdc_basic1_Diabetes[cdc_index_basic1_Diabetes, ]
cdc_te_basic1_Diabetes <- cdc_basic1_Diabetes[-cdc_index_basic1_Diabetes, ]


control_basic1_Diabetes <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic1_Diabetes <- train(Diabetes ~ .,
                    data=cdc_tr_basic1_Diabetes,
                    method="lm",
                    trControl = control_basic1_Diabetes)
print(model_basic1_Diabetes$resample)

model_basic1_Diabetes

importance_basic1_Diabetes <- varImp(model_basic1_Diabetes, scale=TRUE)
plot(importance_basic1_Diabetes)

```


#### View coefficients basic model 1
```{r}
coef(model_basic1_Diabetes$finalModel)

```


### Basic Model 2(Diabetes) now added "Smoker", "Age65Plus" 94% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic2_Diabetes <- cdc %>% select("Diabetes", "CHD", "HighBP", "HighChol", "Stroke", "Smoker", "Age65Plus")

# cdc_basic2_Diabetes$UrbanRural <- factor(ifelse(cdc_basic2_Diabetes$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic2_Diabetes <- createDataPartition(cdc_basic2_Diabetes$Diabetes, p = 0.8, list = FALSE)
cdc_tr_basic2_Diabetes <- cdc_basic2_Diabetes[cdc_index_basic2_Diabetes, ]
cdc_te_basic2_Diabetes <- cdc_basic2_Diabetes[-cdc_index_basic2_Diabetes, ]


control_basic2_Diabetes <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic2_Diabetes <- train(Diabetes ~ . -UrbanRural,
                    data=cdc_tr_basic2_Diabetes,
                    method="lm",
                    trControl = control_basic2_Diabetes)
print(model_basic2_Diabetes$resample)

model_basic2_Diabetes

importance_basic2_Diabetes <- varImp(model_basic2_Diabetes, scale=TRUE)
plot(importance_basic2_Diabetes)

```


#### View coefficients basic model 2
```{r}
coef(model_basic2_Diabetes$finalModel)

```


### Basic Model 3(Diabetes) now added "CholMedElegible", "HealthIns" 94.9% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic3_Diabetes <- cdc %>% select("Diabetes", "CHD", "HighBP", "HighChol", "Stroke", "Smoker", "Age65Plus", "CholMedElegible", "HealthIns")

# cdc_basic3_Diabetes$UrbanRural <- factor(ifelse(cdc_basic3_Diabetes$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic3_Diabetes <- createDataPartition(cdc_basic3_Diabetes$Diabetes, p = 0.8, list = FALSE)
cdc_tr_basic3_Diabetes <- cdc_basic3_Diabetes[cdc_index_basic3_Diabetes, ]
cdc_te_basic3_Diabetes <- cdc_basic3_Diabetes[-cdc_index_basic3_Diabetes, ]


control_basic3_Diabetes <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic3_Diabetes <- train(Diabetes ~ . -UrbanRural,
                    data=cdc_tr_basic3_Diabetes,
                    method="lm",
                    trControl = control_basic3_Diabetes)
print(model_basic3_Diabetes$resample)

model_basic3_Diabetes

importance_basic3_Diabetes <- varImp(model_basic3_Diabetes, scale=TRUE)
plot(importance_basic3_Diabetes)

```


#### View coefficients basic model 3
```{r}
coef(model_basic3_Diabetes$finalModel)

```


### Basic Model 4(Diabetes) now removed  "HighBP", "HighChol", "Stroke" 90.1% R2
```{r}
set.seed(123)

#create dataset for model
cdc_basic4_Diabetes <- cdc %>% select("Diabetes", "Stroke", "Age65Plus", "Smoker", "HealthIns", "Parks", "Obesity", "MedHouseIncome", "Diabetes", "CholScreen", "UrbanRural", "SNAPrecipients", "Broadband", "AirQuality", "Pharmacies", "EdLessColl", "PhysInactivity", "Hospitals", "Poverty", "pcp", )

cdc_basic4_Diabetes$UrbanRural <- factor(ifelse(cdc_basic4_Diabetes$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

#train test split
cdc_index_basic4_Diabetes <- createDataPartition(cdc_basic4_Diabetes$Diabetes, p = 0.8, list = FALSE)
cdc_tr_basic4_Diabetes <- cdc_basic4_Diabetes[cdc_index_basic4_Diabetes, ]
cdc_te_basic4_Diabetes <- cdc_basic4_Diabetes[-cdc_index_basic4_Diabetes, ]


control_basic4_Diabetes <- trainControl(method="repeatedcv", number =5, repeats=3)
#Rsquared xx%
model_basic4_Diabetes <- train(Diabetes ~ .,
                    data=cdc_tr_basic4_Diabetes,
                    method="lm",
                    trControl = control_basic4_Diabetes)
print(model_basic4_Diabetes$resample)

model_basic4_Diabetes

importance_basic4_Diabetes <- varImp(model_basic4_Diabetes, scale=TRUE)
plot(importance_basic4_Diabetes)

```


#### View coefficients basic model 4
```{r}
coef(model_basic4_Diabetes$finalModel)

```

