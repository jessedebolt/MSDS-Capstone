---
title: "MSDS 2023 Capstone Project"
author: "Jesse DeBolt & Isaac Johnson"
date: "`r Sys.Date()`"
format: html
subtitle: Tertiary document for specific (Stroke) target models
---

#.
# Setup
#.

### Load libraries and knit setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(readr)
library(caret)
library(dplyr)
library(tidyverse)

```


### Read in dataset and descriptions
```{r}
cdc <- read_csv("data/CDC_all.csv")
TableDesc <- read_csv("data_support/Table_Descriptions.csv")

```

#.
# Data Cleaning
#.

## Feature reduction
### Remove unneeded/duplicated columns
```{r}
# Select and rearrange columns
cdc <- cdc %>% select(c("county", "state", "UrbanRural", "CHD", "HighBP", "HighChol", "Stroke", "Diabetes", "Obesity", "PhysInactivity", "Smoker", "Age65Plus","CholScreen", "CholMedNonAdhear", "CholMedElegible", "cruParticipate", "bpmUse", "MedHouseIncome", "Poverty", "Unemploy", "SNAPrecipients", "EdLessColl", "MedHomeValue", "HealthIns", "AirQuality", "Parks", "Broadband","pcp", "CardioPhys", "Hospitals", "Pharmacies", "pop"))

```


## Modify features
### Change Urban/Rural to binary
```{r}
# Convert to 1=Urban, 0=Rural as factor
cdc$UrbanRural <- factor(ifelse(cdc$UrbanRural %in% c("Large_Urban", "LargeFringe_Urban", "MediumSmall_Urban"), 1, 0))

```

#.
# HiChol Linear Models
#.

## Full Model
### Full model with all features (full)
```{r}
# Set the seed
set.seed(2112)

# Train test split
cdc_index_full <- createDataPartition(cdc$Stroke, p = 0.8, list = FALSE)
cdc_tr_full <- cdc[cdc_index_full, ]
cdc_te_full <- cdc[-cdc_index_full, ]

# Set control requirements
control_full <- trainControl(method="repeatedcv", 
                             number =5,
                             repeats=3)

# Fit the model
model_full <- train(Stroke ~ . -county -state, 
                    data=cdc_tr_full, 
                    method="lm", 
                    trControl = control_full)

print(model_full$resample)
model_full

importance_full <- varImp(model_full, scale=TRUE)
plot(importance_full)

```


## Main Model
### Full model less other targets (main)
```{r}
# Set the seed
set.seed(2112)

# Train test split
cdc_index_main <- createDataPartition(cdc$Stroke, p = 0.8, list = FALSE)
cdc_tr_main <- cdc[cdc_index_main, ]
cdc_te_main <- cdc[-cdc_index_main, ]

# Set control requirements
control_main <- trainControl(method="repeatedcv", 
                             number =5,
                             repeats=3)

# Fit the model
model_main <- train(Stroke ~ . -county -state -CHD -HighChol -HighBP , 
                    data=cdc_tr_main, 
                    method="lm", 
                    trControl = control_main)

print(model_main$resample)
model_main

importance_main <- varImp(model_main, scale=FALSE)
plot(importance_main)

```


## Top20 Model
### Full model less other targets and include top 20 features from variable importance shown in (main)
```{r}
# Set the seed
set.seed(2112)

# Train test split
cdc_index_top20 <- createDataPartition(cdc$Stroke, p = 0.8, list = FALSE)
cdc_tr_top20 <- cdc[cdc_index_top20, ]
cdc_te_top20 <- cdc[-cdc_index_top20, ]

# Set control requirements
control_top20 <- trainControl(method="repeatedcv", 
                             number =5,
                             repeats=3)

# Fit the model
model_top20 <- train(Stroke ~ . -county -state -CHD -HighChol -HighBP -Unemploy -pop -MedHouseIncome -AirQuality -Hospitals -CardioPhys, 
                    data=cdc_tr_top20, 
                    method="lm", 
                    trControl = control_top20)

print(model_top20$resample)
model_top20

importance_top20 <- varImp(model_top20, scale=TRUE)
plot(importance_top20)

```


## Top15 Model
### Full model less other targets and include top 15 features from variable importance shown in (main)
```{r}
# Set the seed
set.seed(2112)

# Train test split
cdc_index_top15 <- createDataPartition(cdc$Stroke, p = 0.8, list = FALSE)
cdc_tr_top15 <- cdc[cdc_index_top15, ]
cdc_te_top15 <- cdc[-cdc_index_top15, ]

# Set control requirements
control_top15 <- trainControl(method="repeatedcv", 
                             number =5,
                             repeats=3)

# Fit the model
model_top15 <- train(Stroke ~ . -county -state -CHD -HighChol -HighBP -Unemploy -pop -MedHouseIncome -AirQuality -Hospitals -CardioPhys -pcp -PhysInactivity -Obesity -Pharmacies -cruParticipate,  
                    data=cdc_tr_top15, 
                    method="lm", 
                    trControl = control_top15)

print(model_top15$resample)
model_top15

importance_top15 <- varImp(model_top15, scale=TRUE)
plot(importance_top15)

```


## Top10 Model
### Full model less other targets and include top 10 features from variable importance shown in (main)
```{r}
# Set the seed
set.seed(2112)

# Train test split
cdc_index_top10 <- createDataPartition(cdc$Stroke, p = 0.8, list = FALSE)
cdc_tr_top10 <- cdc[cdc_index_top10, ]
cdc_te_top10 <- cdc[-cdc_index_top10, ]

# Set control requirements
control_top10 <- trainControl(method="repeatedcv", 
                             number =5,
                             repeats=3)

# Fit the model
model_top10 <- train(Stroke ~ . -county -state -CHD -HighChol -HighBP -Unemploy -pop -MedHouseIncome -AirQuality -Hospitals -CardioPhys -pcp -PhysInactivity -Obesity -Pharmacies -cruParticipate -CholScreen -Parks -Diabetes -CholMedNonAdhear -UrbanRural,  
                    data=cdc_tr_top10, 
                    method="lm", 
                    trControl = control_top10)


print(model_top10$resample)
model_top10

importance_top10 <- varImp(model_top10, scale=TRUE)
plot(importance_top10)

```


## Top5 Model
### Full model less other targets and include top 5 features from variable importance shown in (main)
```{r}
# Set the seed
set.seed(2112)

# Train test split
cdc_index_top5 <- createDataPartition(cdc$Stroke, p = 0.8, list = FALSE)
cdc_tr_top5 <- cdc[cdc_index_top5, ]
cdc_te_top5 <- cdc[-cdc_index_top5, ]

# Set control requirements
control_top5 <- trainControl(method="repeatedcv", 
                             number =5,
                             repeats=3)

# Fit the model
model_top5 <- train(Stroke ~ . -county -state -CHD -HighChol -HighBP -Unemploy -pop -MedHouseIncome -AirQuality -Hospitals -CardioPhys -pcp -PhysInactivity -Obesity -Pharmacies -cruParticipate -CholScreen -Parks -Diabetes -CholMedNonAdhear -CholMedElegible -EdLessColl -MedHomeValue -Broadband -HealthIns -UrbanRural,  
                    data=cdc_tr_top5, 
                    method="lm", 
                    trControl = control_top5)

print(model_top5$resample)
model_top5

importance_top5 <- varImp(model_top5, scale=TRUE)
plot(importance_top5)

```


### Obtaining the r squared results from each model
```{r}
# Access R-squared
full_rsquared <- (summary(model_full)$r.squared)
main_rsquared <- (summary(model_main)$r.squared)
top20_rsquared <- (summary(model_top20)$r.squared)
top15_rsquared <- (summary(model_top15)$r.squared)
top10_rsquared <- (summary(model_top10)$r.squared)
top5_rsquared <- (summary(model_top5)$r.squared)

# Print R-squared
print(paste("Full model R-squared =", sprintf("%.5f", full_rsquared)))
print(paste("Main model R-squared =", sprintf("%.5f", main_rsquared)))
print(paste("Top20 model R-squared =", sprintf("%.5f", top20_rsquared)))
print(paste("Top15 model R-squared =", sprintf("%.5f", top15_rsquared)))
print(paste("Top10 model R-squared =", sprintf("%.5f", top10_rsquared)))
print(paste("Top5 model R-squared =", sprintf("%.5f", top5_rsquared)))

```


## Cycle Model
### Model with one variable at a time (cycle)
```{r}
# Set the seed
set.seed(2112)

# Train test split
cdc_index_cycle <- createDataPartition(cdc$Stroke, p = 0.8, list = FALSE)
cdc_tr_cycle <- cdc[cdc_index_cycle, ]
cdc_te_cycle <- cdc[-cdc_index_cycle, ]

# Set control requirements
control_cycle <- trainControl(method="repeatedcv", 
                             number =5,
                             repeats=3)

# List of y variables
y_var_list <- c("UrbanRural", "Diabetes", "Obesity",
                "PhysInactivity", "Smoker", "Age65Plus",
                "CholScreen", "CholMedNonAdhear",
                "CholMedElegible", "cruParticipate",
                "bpmUse", "MedHouseIncome", "Poverty",
                "Unemploy", "SNAPrecipients", "EdLessColl",
                "MedHomeValue", "HealthIns", "AirQuality",
                "Parks", "Broadband", "pcp", "CardioPhys",
                "Hospitals", "Pharmacies", "pop")

# Initialize an empty data frame to store results
cycle_results <- data.frame()

# Loop through each y variable
for (y_var in y_var_list){
  # Fit the model
  model_cycle <- train(reformulate(y_var, "Stroke"),
                       data=cdc_tr_cycle, 
                       method="lm", 
                       trControl = control_cycle)
  
  # Extract metrics
  rmse <- model_cycle$results$RMSE[which.min(model_cycle$results$RMSE)]  # Best RMSE
  r_squared <- max(model_cycle$results$Rsquared)  # Best R-squared

  # Add results to data frame
  cycle_results <- rbind(cycle_results, data.frame(y_var = y_var, RMSE = rmse, R_Squared = r_squared))
}
  
# Sort the results by R_Squared in descending order
sorted_cycle_results <- cycle_results[order(-cycle_results$R_Squared),]

# Print the sorted results
print(sorted_cycle_results)

```


#.
# HiChol Linear Model with interactions
#.

## Add previous grouped models to the results table
```{r}
# Put models in a list
model_list <- list(model_top5 = model_top5, 
                   model_top10 = model_top10, 
                   model_top15 = model_top15, 
                   model_top20 = model_top20, 
                   model_full = model_full)

# Loop through each model
for (model_name in names(model_list)) {
  # Extract model from list
  model <- model_list[[model_name]]
  
  # Extract metrics
  rmse <- model$results$RMSE[which.min(model$results$RMSE)]  # Best RMSE
  r_squared <- max(model$results$Rsquared)  # Best R-squared

  # Add results to data frame
  cycle_results <- rbind(cycle_results, data.frame(y_var = model_name, RMSE = rmse, R_Squared = r_squared))
}

# Sort the results by R_Squared in descending order
sorted_cycle_results <- cycle_results[order(-cycle_results$R_Squared),]

print(sorted_cycle_results)

```


## Interactions between Urban/Rural and various factors
```{r}
# Set the seed
set.seed(2112)

# Train test split
cdc_index_multiX <- createDataPartition(cdc$Stroke, p = 0.8, list = FALSE)
cdc_tr_multiX <- cdc[cdc_index_multiX, ]
cdc_te_multiX <- cdc[-cdc_index_multiX, ]

# Set control requirements
control_multiX <- trainControl(method="repeatedcv", 
                             number =5,
                             repeats=3)

# List of y variables
y_var_list_multiX <- c("UrbanRural*Smoker",
                "UrbanRural*Age65Plus",
                "UrbanRural*CholScreen",
                "UrbanRural*CholMedNonAdhear",
                "UrbanRural*CholMedElegible",
                "UrbanRural*MedHouseIncome",
                "UrbanRural*MedHomeValue",
                "UrbanRural*HealthIns",
                "UrbanRural*AirQuality",
                "UrbanRural*Broadband",
                "UrbanRural*pcp",
                "UrbanRural*CardioPhys",
                "UrbanRural*Hospitals",
                "UrbanRural*Pharmacies",
                "UrbanRural*pop"
                )

# Initialize an empty data frame to store results
multiX_results <- data.frame()

# Loop through each y variable
for (y_var in y_var_list_multiX){
  # Fit the model
  model_multiX <- train(reformulate(y_var, "Stroke"),
                       data=cdc_tr_multiX, 
                       method="lm", 
                       trControl = control_multiX)
  
  # Extract metrics
  rmse <- model_multiX$results$RMSE[which.min(model_multiX$results$RMSE)]  # Best RMSE
  r_squared <- max(model_multiX$results$Rsquared)  # Best R-squared

  # Add results to data frame
  multiX_results <- rbind(multiX_results, data.frame(y_var = y_var, RMSE = rmse, R_Squared = r_squared))
}
  
# Sort the results by R_Squared in descending order
sorted_multiX_results <- multiX_results[order(-multiX_results$R_Squared),]

# Print the sorted results
print(sorted_multiX_results)

```

#.
# Results
#.

## Combined results RMSE and R^2
```{r}
# Add lists together into new table
all_results <- rbind(sorted_cycle_results, sorted_multiX_results)

# Sort results by RMSE values
all_results <- all_results[order(-all_results$R_Squared),]

print(all_results)
```


## Combined results: Coefficients
```{r}
# List of models
models <- list(full = model_full, 
               main = model_main, 
               top20 = model_top20, 
               top15 = model_top15,
               top10 = model_top10,
               top5 = model_top5)

# Create an empty list to store coefficients
coeffs_list <- list()

# Loop over each model
for (model_name in names(models)) {
  # Extract the coefficients of the model
  coeffs <- coef(models[[model_name]]$finalModel)
  
  # Convert to data frame and set column names
  coeffs_df <- data.frame(Variable = names(coeffs), Coefficients = coeffs, stringsAsFactors = FALSE)
  
  # Add a column with the name of the model
  coeffs_df$model <- model_name
  
  # Add the data frame to the list
  coeffs_list[[model_name]] <- coeffs_df
}

# Bind all data frames in the list into a single data frame
df <- bind_rows(coeffs_list)

# Convert to wide format
Stroke_Coef <- pivot_wider(df, names_from = model, values_from = Coefficients)

# Round the coefficients to 4 decimal places
Stroke_Coef[-1] <- round(Stroke_Coef[-1], 3)

# View the data frame
print(Stroke_Coef)

```


### Add label to each variable for this model set
```{r}
# Add "_HighBP" to each variable name
Stroke_Coef$Variable <- paste(Stroke_Coef$Variable, "_Stroke", sep = "")

# View the data frame
print(Stroke_Coef)

```










## Top5 Model WITH interactions UrbanRural (rename modelname, etc?) (all except UrbanRural1:SNAPrecipients are significant) R2 85.8
### added poverty interactions 86.9 (age65Plus bpmUse SNAPrecipients significant)
### Full model less other targets and include top 5 features from variable importance shown in (main)
```{r}
# Set the seed
set.seed(2112)

# Train test split
cdc_index_top5 <- createDataPartition(cdc$Stroke, p = 0.8, list = FALSE)
cdc_tr_top5 <- cdc[cdc_index_top5, ]
cdc_te_top5 <- cdc[-cdc_index_top5, ]

# Set control requirements
control_top5 <- trainControl(method="repeatedcv", 
                             number =5,
                             repeats=3)

# Fit the model
model_top5 <- train(Stroke ~ . -county -state -CHD -HighChol -HighBP -Unemploy -pop -MedHouseIncome -AirQuality -Hospitals -CardioPhys -pcp -PhysInactivity -Obesity -Pharmacies -cruParticipate -CholScreen -Parks -Diabetes -CholMedNonAdhear -CholMedElegible -EdLessColl -MedHomeValue -Broadband -HealthIns + Age65Plus*UrbanRural + Poverty*UrbanRural + Smoker*UrbanRural + bpmUse*UrbanRural + SNAPrecipients*UrbanRural + Age65Plus*Poverty + Poverty*UrbanRural + Smoker*Poverty + bpmUse*Poverty + SNAPrecipients*Poverty,  
                    data=cdc_tr_top5, 
                    method="lm", 
                    trControl = control_top5)

print(model_top5$resample)
model_top5

importance_top5 <- varImp(model_top5, scale=TRUE)
plot(importance_top5)

summary(model_top5)
```
